# 🎛️ 智能控制系统使用说明

## ✅ 已完成功能

### 1. 智能Token控制
- ✅ **每日Token限制** - 设置每天的Token使用上限
- ✅ **实时监控** - 显示今日已使用Token和剩余额度
- ✅ **自动阻止** - 达到限额后自动停止所有生成
- ✅ **自动重置** - 每天0点自动重置使用量

### 2. 时间控制
- ✅ **运行时间段** - 设置允许自动生成的时间范围（如：9:00-21:00）
- ✅ **自动停止** - 超出时间范围自动停止生成

### 3. 全局控制
- ✅ **全局开关** - 一键关闭/开启所有自动化功能
- ✅ **紧急停止** - 立即停止所有房间的自动对话和朋友圈生成
- ✅ **房间状态监控** - 查看所有房间的自动化状态

### 4. 实时统计
- ✅ **Token使用统计** - 实时显示Token消耗
- ✅ **使用率监控** - 进度条显示使用百分比，颜色预警
- ✅ **生成数量统计** - 显示今日生成的对话和朋友圈数量
- ✅ **自动刷新** - 每30秒自动更新统计数据

## 🎯 如何使用

### 访问智能控制面板
1. 打开管理后台：`/admin`
2. 点击"🎛️ 智能控制"标签页
3. 查看实时监控数据

### 配置Token限制
1. 在"每日Token限制"输入框中设置限额（如：100000）
2. 失焦后自动保存配置
3. 达到限额后，所有自动生成将停止，并显示提示

### 设置运行时间
1. 在"允许运行时间"中设置开始和结束时间（0-24）
2. 例如：8:00 至 22:00 表示只在这个时间段内自动生成
3. 超出时间范围时，生成请求会被自动阻止

### 使用全局开关
- **开启**：勾选"全局自动化开关"，所有符合条件的房间开始自动生成
- **关闭**：取消勾选，立即停止所有自动化功能

### 紧急停止
当需要立即停止所有自动化时：
1. 点击"🚨 紧急停止所有自动化"按钮
2. 确认操作
3. 系统将：
   - 关闭全局自动化开关
   - 停止所有房间的自动对话
   - 停止朋友圈自动生成

## 📊 监控指标说明

### Token使用进度条颜色
- 🟢 **绿色**（0-50%）：使用正常
- 🔵 **蓝色**（50-75%）：使用正常偏高
- 🟡 **黄色**（75-90%）：使用较多，注意控制
- 🔴 **红色**（90-100%）：接近限额，即将停止

### 房间状态
- 🟢 **开启**：房间的自动对话功能已开启
- ⚫ **关闭**：房间的自动对话功能已关闭

## ⚙️ 工作原理

### 智能检查流程
每次生成对话或朋友圈前，系统会自动检查：

1. **全局开关** → 是否开启？
2. **Token限额** → 是否超过每日限制？
3. **时间范围** → 当前时间是否在允许范围内？
4. **房间设置** → 该房间是否开启自动模式？

只有全部通过检查，才会执行生成。

### Token统计
- 自动估算每次生成使用的Token数量
- 中文按1.5 tokens/字估算
- 英文按0.25 tokens/单词估算
- 计入prompt的Token（约为生成内容的2倍）

## 🔧 群聊自动对话改进

### 之前的问题
❌ 必须保持房间页面打开才能生成
❌ 关闭页面后自动对话停止
❌ 只有创建者在线才工作

### 现在的改进
✅ 在管理后台统一控制
✅ 不依赖前端页面，由智能控制系统管理
✅ 严格遵守Token限制和时间范围
✅ 自动记录和统计使用量

## 💡 使用建议

### 节省Token的最佳实践
1. **设置合理的每日限额**
   - 测试环境：10,000 - 50,000
   - 生产环境：50,000 - 200,000
   - 根据实际需求调整

2. **限制运行时间**
   - 设置为工作时间（如9:00-18:00）
   - 或用户活跃时间段
   - 避免深夜无人时浪费

3. **按需开启房间**
   - 不是所有房间都需要自动对话
   - 只为活跃房间开启自动模式
   - 定期检查房间状态

4. **监控使用情况**
   - 每天查看Token使用统计
   - 注意使用率趋势
   - 及时调整策略

### 紧急情况处理
如果发现Token消耗过快：
1. 点击"紧急停止"按钮
2. 检查各房间的自动模式状态
3. 调整Token限额和运行时间
4. 重新开启需要的自动化功能

## 📈 未来改进方向
- [ ] 在线用户检测（目前暂未实现，需要WebSocket支持）
- [ ] 按房间设置独立的Token配额
- [ ] 更精确的Token计量（调用API获取实际使用量）
- [ ] 历史使用数据图表
- [ ] 按小时统计和预测

## ❓ 常见问题

### Q: 为什么开启自动模式后还是不生成？
A: 检查以下几点：
1. 全局自动化开关是否开启
2. Token是否已达到每日限额
3. 当前时间是否在允许范围内
4. 该房间的auto_mode是否为1

### Q: Token统计准确吗？
A: 目前是估算值，实际消耗可能有10-20%的误差。已包含prompt的token在内。

### Q: 可以为不同房间设置不同的限制吗？
A: 目前是全局统一限制，未来版本会支持按房间设置。

### Q: 紧急停止会删除数据吗？
A: 不会，只是关闭自动化功能，所有已生成的数据都保留。

## 🎉 总结
现在你的自动化系统已经完全可控！
- ✅ Token使用有限制，不会失控
- ✅ 可以设置运行时间，避免浪费
- ✅ 实时监控，心中有数
- ✅ 一键紧急停止，安全可靠

放心使用吧！🚀

