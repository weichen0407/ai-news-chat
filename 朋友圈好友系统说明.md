# 🎭 朋友圈好友系统说明

## 🎯 核心概念

### 好友关系定义
**好友 = 玩家加入房间后，房间里的所有NPC**

例如：
- 玩家加入"王宝强事件"房间 → 王宝强、马蓉、宋喆成为好友
- 玩家加入"特朗普vs拜登"房间 → 特朗普、拜登成为好友
- 玩家同时加入多个房间 → 所有房间的NPC都是好友

### 朋友圈可见性
- ✅ 玩家可以看到自己发布的朋友圈
- ✅ 玩家可以看到所有好友NPC发布的朋友圈
- ✅ NPC可以看到玩家的朋友圈
- ❌ 不同玩家之间暂时看不到（后续功能）

---

## 🚀 功能特点

### 1. 发布朋友圈
- **玩家发布**：
  - 不需要选择房间
  - 所有好友NPC都能看到
  - 发布后3-12秒，40%的好友NPC会自动评论

- **NPC发布**：
  - NPC会自动发布朋友圈（需要手动或定时触发）
  - 内容基于NPC的性格、习惯、目标、背景
  - 与NPC是好友的玩家都能看到

### 2. 互动功能
- **点赞**：玩家可以点赞任何朋友圈
- **评论**：玩家可以评论任何朋友圈
- **NPC自动评论**：玩家发布后，NPC会自动评论

---

## 🧪 测试流程

### Step 1: 登录
```
http://localhost:3001/login

用户名：jerry
密码：123123
```

### Step 2: 建立好友关系
1. 进入首页，点击"聊天"Tab
2. 加入一个预设房间（例如：王宝强离婚风波）
3. 此时，该房间的NPC（王宝强、马蓉、宋喆）成为你的好友

### Step 3: 查看朋友圈
1. 点击"朋友圈"Tab
2. 如果已有NPC发布过朋友圈，可以看到
3. 如果没有，继续下一步

### Step 4: 发布朋友圈
1. 点击右上角"➕"按钮
2. 输入内容，例如："今天天气真好！"
3. 点击"发布"
4. **等待3-12秒**
5. 刷新页面或重新进入朋友圈
6. 你会看到王宝强、马蓉或宋喆的评论

### Step 5: 触发NPC发朋友圈
在终端执行：
```bash
curl -X POST http://localhost:3001/api/moments/npc-auto-post
```

这会让所有NPC中的5%随机发布朋友圈。

然后：
1. 返回朋友圈Tab
2. 刷新页面
3. 查看NPC发布的内容

---

## 🔧 API端点

### 1. 获取好友朋友圈
```
GET /api/moments/friends
返回：当前用户和所有好友NPC的朋友圈
```

### 2. 发布朋友圈（玩家）
```
POST /api/moments/create
Body: {
  "user_id": 1,
  "content": "朋友圈内容"
}
```

### 3. AI生成NPC朋友圈
```
POST /api/moments/ai-generate
Body: {
  "npc_id": 1
}
```

### 4. 触发NPC自动发朋友圈
```
POST /api/moments/npc-auto-post
随机让5%的NPC发布朋友圈
```

### 5. 触发好友NPC自动评论
```
POST /api/moments/ai-auto-comment-friends
Body: {
  "moment_id": 1,
  "user_id": 1
}
让玩家的所有好友NPC评论（40%概率）
```

---

## 🤖 NPC自动行为

### NPC评论概率
- 玩家发布朋友圈后
- 每个好友NPC有40%的概率评论
- 延迟2-12秒（模拟真实情况）

### NPC发朋友圈概率
- 调用自动发布API时
- 每个NPC有5%的概率发布
- 内容基于NPC的人设

### 评论内容
NPC的评论会考虑：
- NPC的性格
- NPC的习惯
- 朋友圈的内容
- NPC和发布者的关系

---

## 📊 数据库结构

### moments表
```sql
room_id: NULL  -- 不再绑定房间
user_id: 玩家ID（如果是玩家发布）
npc_id: NPC ID（如果是NPC发布）
content: 朋友圈内容
images: 图片（JSON数组）
```

### 好友关系查询
```sql
-- 查询用户的所有好友NPC
SELECT DISTINCT n.id, n.name
FROM npcs n
INNER JOIN room_members rm ON n.room_id = rm.room_id
WHERE rm.user_id = ?
```

---

## 🎬 完整测试示例

### 场景1：玩家发布 → NPC评论
1. 登录jerry账号
2. 加入"王宝强离婚风波"房间
3. 发布朋友圈："周末愉快！"
4. 等待10秒
5. 刷新朋友圈
6. 看到王宝强评论："你也是，好好休息！"
7. 看到马蓉评论："周末快乐~"

### 场景2：NPC发布 → 玩家查看
1. 执行：`curl -X POST http://localhost:3001/api/moments/npc-auto-post`
2. 返回朋友圈Tab
3. 刷新页面
4. 看到王宝强发布："今天拍戏很累，但是很充实。这就是演员的生活吧。"
5. 可以点赞和评论

### 场景3：多个房间好友
1. 登录jerry账号
2. 加入"王宝强离婚风波"房间
3. 加入"特朗普vs拜登"房间
4. 发布朋友圈："今天发生了很多事"
5. 等待
6. 刷新朋友圈
7. 可能看到：
   - 王宝强的评论
   - 特朗普的评论
   - 拜登的评论

---

## 🐛 常见问题

### Q1: 发布后看不到NPC评论
**原因**：评论是异步的，有2-12秒延迟

**解决**：等待15秒后刷新页面

### Q2: 朋友圈Tab是空的
**原因**：
1. 没有加入任何房间（没有好友NPC）
2. NPC还没有发布过朋友圈

**解决**：
1. 先加入一个房间
2. 手动触发NPC发朋友圈：`curl -X POST http://localhost:3001/api/moments/npc-auto-post`

### Q3: NPC发的朋友圈内容不符合人设
**原因**：AI生成的内容质量取决于NPC的人设信息是否完整

**解决**：确保NPC有完整的属性：性格、习惯、目标、背景

---

## 🚀 后续功能建议

1. **定时任务**：自动每小时让NPC发朋友圈
2. **玩家互相关注**：玩家之间也能看到朋友圈
3. **朋友圈图片**：支持上传图片
4. **表情包**：支持表情包评论
5. **NPC互相评论**：NPC之间互相点赞评论
6. **通知系统**：被评论时发送通知

---

**现在开始测试吧！** 🎉

http://localhost:3001

