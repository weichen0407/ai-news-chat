# 🔧 朋友圈数据库表结构修复

## ❌ 问题描述

部署到 Railway 后，朋友圈功能报错：

```
table moments has no column named room_id
```

## 🔍 问题根源

应用中 `moments` 表有**两个不同的定义**：

### 版本 A：旧版本（错误）
在 `server/utils/db.ts` 和最初的 `start.mjs` 中：
```sql
CREATE TABLE moments (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id INTEGER,
  npc_id INTEGER,
  author_type TEXT NOT NULL,     -- ❌ 使用 author_type
  content TEXT NOT NULL,
  images TEXT,
  like_count INTEGER DEFAULT 0,  -- ❌ 冗余字段
  comment_count INTEGER DEFAULT 0, -- ❌ 冗余字段
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP
)
-- ❌ 缺少 room_id 字段！
```

### 版本 B：新版本（正确）
在 `server/utils/db-moments.ts` 和实际使用的代码中：
```sql
CREATE TABLE moments (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  room_id TEXT NOT NULL,         -- ✅ 必需的房间ID
  user_id INTEGER,
  npc_id INTEGER,
  content TEXT NOT NULL,
  images TEXT,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP
)
```

### 依赖 room_id 的功能

很多功能都依赖 `room_id` 字段：

1. **房间朋友圈隔离** - `server/api/moments/room/[roomId].get.ts`
2. **未读统计** - `server/utils/db-moments.ts`
3. **已读状态** - `moment_read_status` 表也按 room_id 分组

---

## ✅ 修复方案

### 1. 统一表结构

修改 `start.mjs`，使用正确的表结构（包含 `room_id`）：

```javascript
chatDb.exec(`
  CREATE TABLE IF NOT EXISTS moments (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    room_id TEXT NOT NULL,        -- ✅ 添加 room_id
    user_id INTEGER,
    npc_id INTEGER,
    content TEXT NOT NULL,
    images TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
  )
`)
```

### 2. 添加自动数据库迁移

在 `start.mjs` 中添加迁移逻辑，自动检测并修复旧表：

```javascript
// 检查 moments 表是否有 room_id 字段
const momentsInfo = chatDb.pragma('table_info(moments)')
const hasRoomId = momentsInfo.some(col => col.name === 'room_id')

if (!hasRoomId) {
  console.log('⚠️  检测到 moments 表缺少 room_id 字段，正在添加...')
  chatDb.exec(`ALTER TABLE moments ADD COLUMN room_id TEXT`)
  console.log('✅ room_id 字段添加成功')
}
```

### 3. 修复其他表结构差异

**moment_likes 表：**
- 旧版：没有 `id` 主键
- 新版：添加 `id INTEGER PRIMARY KEY AUTOINCREMENT`

**moment_comments 表：**
- 旧版：缺少 `reply_to_user_id` 和 `reply_to_npc_id`
- 新版：支持回复功能

**moment_read_status 表：**
- 旧版：只有 `user_id`，全局统计
- 新版：`user_id + room_id`，按房间统计

---

## 🚀 部署流程

### 已完成的操作 ✅

1. ✅ 修改 `start.mjs` 中的表结构
2. ✅ 添加自动数据库迁移逻辑
3. ✅ 提交代码到 Git
4. ✅ 推送到 GitHub

### Railway 自动处理

Railway 检测到代码更新后会：

1. **重新构建** Docker 镜像 (3-5分钟)
2. **启动应用** 运行 `start.mjs`
3. **自动迁移** 检测并修复 `chat.db` 表结构
4. **应用上线** 朋友圈功能正常

---

## 📋 预期日志

部署成功后，在 Railway 日志中应该看到：

```
💾 朋友圈数据库路径: /app/data/chat.db
✅ 朋友圈数据库连接成功
✅ 朋友圈表结构创建完成
⚠️  检测到 moments 表缺少 room_id 字段，正在添加...
✅ room_id 字段添加成功
✅ 所有检查通过，启动Nuxt应用...
```

如果是全新数据库（首次部署）：
```
💾 朋友圈数据库路径: /app/data/chat.db
✅ 朋友圈数据库连接成功
✅ 朋友圈表结构创建完成
✅ 所有检查通过，启动Nuxt应用...
```

---

## 🧪 测试验证

### 1. 测试朋友圈基本功能

访问：`https://你的域名.up.railway.app/moments`

- ✅ 页面正常加载，不报错
- ✅ 可以查看朋友圈列表
- ✅ 可以发布新朋友圈

### 2. 测试房间隔离

访问不同房间的朋友圈：
- `https://你的域名.up.railway.app/room/PRESET_TRUMP/moments`
- `https://你的域名.up.railway.app/room/其他房间ID/moments`

- ✅ 每个房间只显示该房间的朋友圈
- ✅ 朋友圈按 `room_id` 正确隔离

### 3. 测试点赞和评论

- ✅ 可以点赞朋友圈
- ✅ 可以评论朋友圈
- ✅ 可以回复评论

---

## 📊 数据库对比

### 完整的表结构对比

| 字段 | 旧版本 | 新版本 | 说明 |
|------|--------|--------|------|
| `id` | ✅ | ✅ | 主键 |
| `room_id` | ❌ | ✅ | **新增**，房间隔离必需 |
| `user_id` | ✅ | ✅ | 用户ID |
| `npc_id` | ✅ | ✅ | NPC ID |
| `author_type` | ✅ | ❌ | **删除**，冗余字段 |
| `content` | ✅ | ✅ | 内容 |
| `images` | ✅ | ✅ | 图片 |
| `like_count` | ✅ | ❌ | **删除**，改用子查询 |
| `comment_count` | ✅ | ❌ | **删除**，改用子查询 |
| `created_at` | ✅ | ✅ | 创建时间 |

---

## ⚠️ 注意事项

### 1. 数据持久化

- Railway 使用 Volume 挂载 `/app/data` 目录
- `chat.db` 和 `app.db` 都会持久保存
- 重新部署不会丢失数据

### 2. 迁移安全性

- 使用 `ALTER TABLE ADD COLUMN` 添加字段，不会丢失数据
- 现有的朋友圈数据会保留
- 新字段 `room_id` 会是 NULL，需要后续手动填充

### 3. 旧数据处理

如果有旧数据（`room_id` 为 NULL）：

```sql
-- 需要根据 npc_id 或 user_id 推断 room_id
UPDATE moments 
SET room_id = (
  SELECT room_id FROM npcs WHERE npcs.id = moments.npc_id
)
WHERE npc_id IS NOT NULL AND room_id IS NULL;
```

---

## 🎉 完成

修复完成后，朋友圈功能应该：

- ✅ 不再报 "no column named room_id" 错误
- ✅ 正确按房间隔离朋友圈内容
- ✅ 点赞、评论、回复功能正常
- ✅ 未读统计准确

---

## 📞 问题排查

如果部署后仍有问题：

1. **查看 Railway 日志**
   - 确认是否有迁移日志
   - 查找是否有错误信息

2. **手动触发重新部署**
   - Railway 控制台 → Deployments → Redeploy

3. **清除旧数据库**（如果数据不重要）
   - 删除 `/app/data/chat.db` Volume
   - 让应用重新初始化全新数据库

---

**修复时间：** 2025-11-06  
**版本：** v2.1.0

