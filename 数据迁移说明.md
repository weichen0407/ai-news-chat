# 📦 数据迁移说明

## ✅ 已完成

已成功导出并准备迁移以下数据到Railway：

---

## 📊 迁移数据清单

### 导出统计
```
✅ 用户: 3个
✅ 房间: 5个  
✅ NPC: 17个
✅ 消息: 44条（每个房间最后10条）
✅ 房间成员: 8条关系
✅ 好友关系: 2条
```

### 导出内容

#### 1. 用户数据 (3个)
- 所有注册用户
- 包括用户名、密码（已加密）、昵称、头像

#### 2. 房间数据 (5个)
- 所有创建的群聊房间
- 包括房间名称、描述、头像、创建者
- 自动模式设置、对话密度等

#### 3. NPC数据 (17个)
- 所有NPC角色
- 包括名称、头像、人设、性格
- 与房间的关联关系

#### 4. 聊天记录 (44条)
- **每个房间保留最后10条消息**
- 包括发送者、内容、时间

#### 5. 房间成员 (8条)
- 用户与房间的加入关系
- 加入时间

#### 6. 好友关系 (2条)
- 用户之间的好友关系
- 用户与NPC的好友关系

---

## 🔄 自动导入机制

### 工作原理

1. **首次部署**：
   - Railway部署时会包含 `server/data/initial-data.json`
   - 应用启动时，`start.mjs` 会自动调用导入脚本
   - 检查数据库是否为空
   - 如果为空，自动导入所有数据

2. **后续部署**：
   - 检测到数据库已有数据
   - 跳过导入，使用现有数据
   - 数据会持久化保存

### 导入流程

```
启动应用
  ↓
创建数据库
  ↓
检查是否为空
  ↓
如果为空 → 读取 initial-data.json
  ↓
执行事务导入
  ↓
导入用户 → 房间 → NPC → 消息 → 成员关系
  ↓
完成启动
```

---

## 📁 相关文件

### 新增文件

1. **`export-data.mjs`**
   - 数据导出脚本
   - 从本地数据库导出数据
   - 生成 `initial-data.json`

2. **`import-initial-data.mjs`**
   - 数据导入脚本
   - 在应用启动时执行
   - 自动导入初始数据

3. **`server/data/initial-data.json`**
   - 导出的数据文件（1.0MB）
   - 包含所有需要迁移的数据
   - 会被包含在Git仓库中

### 修改文件

1. **`start.mjs`**
   - 添加了导入初始数据的调用
   - 在数据库连接后执行

---

## 🚀 部署后效果

### 首次启动日志示例

```
🚀 开始初始化...
📁 数据目录路径: /app/data
💾 数据库路径: /app/data/app.db
初始化数据库...
✅ 数据库连接成功
✅ 数据库写入测试成功

📥 检查是否需要导入初始数据...
   📂 读取初始数据文件...
   🔄 开始导入数据...
      ✅ 导入了 3 个用户
      ✅ 导入了 5 个房间
      ✅ 导入了 17 个NPC
      ✅ 导入了 44 条消息
      ✅ 导入了 8 条成员关系
      ✅ 导入了 2 条好友关系
   ✅ 初始数据导入完成！

✅ 所有检查通过，启动Nuxt应用...
Listening on http://0.0.0.0:3000
```

### 访问效果

部署后访问Railway URL，你会看到：

✅ **已有的用户**
- 可以直接用现有账号登录
- jerry / 123123

✅ **已有的房间**
- 王宝强离婚风波
- 虞书欣恋情曝光
- 等等...

✅ **已有的NPC**
- 王宝强、马蓉、宋喆
- 虞书欣、赵露思
- 等等...

✅ **历史消息**
- 每个房间最后10条消息都在
- 可以看到之前的对话

✅ **好友关系**
- 已建立的好友关系保留

---

## 🔧 手动导出（如果需要）

如果以后需要重新导出数据：

```bash
# 进入项目目录
cd /Users/QRF/Desktop/AI-news

# 运行导出脚本
node export-data.mjs

# 文件会生成在: server/data/initial-data.json
```

---

## 📝 导出数据的规则

### 包含的数据
- ✅ 所有用户
- ✅ 所有房间
- ✅ 所有NPC
- ✅ **每个房间最后10条消息**（而不是全部）
- ✅ 所有房间成员关系
- ✅ 朋友圈最近100条（如果有）
- ✅ 朋友圈评论最近200条（如果有）
- ✅ 所有好友关系

### 不包含的数据
- ❌ 超过10条的历史消息
- ❌ 过期的session
- ❌ 临时数据

### 为什么只保留最后10条消息？

1. **合理大小**：减少数据文件大小
2. **足够上下文**：10条足以让AI了解对话背景
3. **快速加载**：减少首次启动时间
4. **节省空间**：Railway免费版有存储限制

---

## 🎯 验证数据迁移

### 部署后检查清单

1. **用户数据**
   - [ ] 可以用现有账号登录
   - [ ] 用户昵称和头像正确

2. **房间数据**
   - [ ] 可以看到所有房间
   - [ ] 房间名称和头像正确
   - [ ] 可以进入房间

3. **NPC数据**
   - [ ] 房间内有NPC
   - [ ] NPC头像和人设正确
   - [ ] NPC可以正常对话

4. **历史消息**
   - [ ] 进入房间可以看到历史消息
   - [ ] 消息内容和顺序正确

5. **管理后台**
   - [ ] 可以看到所有房间
   - [ ] 可以看到所有NPC
   - [ ] 统计数据正确

---

## 🔄 数据持久化

### Railway数据保存

**好消息**：Railway会自动持久化数据！

- 数据存储在 `/app/data/app.db`
- 重新部署不会丢失数据
- 应用重启数据保留
- 只有首次部署会导入初始数据

### 备份建议

虽然数据持久化，但建议定期备份：

```bash
# 使用Railway CLI下载数据库
railway run cat data/app.db > backup-$(date +%Y%m%d).db
```

---

## 💡 常见问题

### Q1: 如果我想更新导出的数据怎么办？

**A:** 重新运行导出脚本：
```bash
node export-data.mjs
git add server/data/initial-data.json
git commit -m "更新初始数据"
git push
```

### Q2: 数据会重复导入吗？

**A:** 不会！导入脚本会检查数据库是否为空：
- 如果为空 → 导入数据
- 如果有数据 → 跳过导入

### Q3: 如果我想清空Railway上的数据重新导入？

**A:** 
1. 在Railway控制台删除volume（数据卷）
2. 重新部署
3. 应用会重新导入初始数据

### Q4: 导出的JSON文件会占用多少空间？

**A:** 当前导出文件大小：**1.0MB**
- 在Git仓库中不算大
- 不会影响部署速度

### Q5: 我可以修改initial-data.json吗？

**A:** 可以！但要确保：
- JSON格式正确
- ID不要重复
- 时间戳格式正确（ISO 8601）

---

## 🎉 总结

### 迁移方案优势

✅ **自动化**：无需手动导入，应用启动自动处理
✅ **安全**：使用事务，确保数据一致性
✅ **智能**：检测数据库状态，避免重复导入
✅ **灵活**：可以随时重新导出更新数据
✅ **可控**：只迁移必要数据，不迁移垃圾数据

### 部署后你将拥有

- ✅ 3个用户账号（包括管理员jerry）
- ✅ 5个预设房间（含热门话题）
- ✅ 17个NPC角色（完整人设）
- ✅ 44条历史对话（展示效果）
- ✅ 完整的关系网络

**现在可以放心部署到Railway了！🚀**

