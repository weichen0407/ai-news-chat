# 🔧 修复说明 - 预设房间权限和朋友圈数据库

## ✅ 已修复的问题

### 1. 预设房间访问权限问题

**问题描述：**
```
GET /api/messages/PRESET_TRUMP 500 (Internal Server Error)
错误：你不是该房间成员
```

**原因分析：**
预设房间（由 jerry 创建的房间）只有 jerry 用户是成员，其他用户访问时被拒绝。

**修复方案：**
修改了以下 API，允许所有登录用户访问预设房间：

#### ✅ 修复的文件：

1. **`server/api/messages/[roomId].get.ts`** - 获取消息
   - 添加预设房间检测逻辑
   - 预设房间（jerry 创建的）跳过成员验证
   - 添加完整的错误处理

2. **`server/api/messages/send.post.ts`** - 发送消息
   - 允许任何用户在预设房间发言
   - 如果用户没有角色，使用默认昵称

3. **`server/api/rooms/[id]/info.get.ts`** - 获取房间信息
   - 预设房间对所有用户显示为"已加入"状态

4. **`server/api/messages/generate-my-message.post.ts`** - AI 生成消息
   - 支持预设房间生成消息
   - 为预设房间用户提供默认角色信息

---

### 2. 朋友圈数据库初始化问题

**问题描述：**
```
no such table: moments
```

**原因分析：**
应用使用了两个数据库：
- `app.db` - 主数据库（用户、房间、NPC、消息）
- `chat.db` - 朋友圈数据库（moments 表）

但是 `start.mjs` 只初始化了 `app.db`，没有创建 `chat.db` 的表结构。

**修复方案：**

#### ✅ 修复的文件：

1. **`start.mjs`** - 启动脚本
   - 添加 chat.db 数据库初始化
   - 创建所有朋友圈相关表：
     - `moments` - 朋友圈内容
     - `moment_likes` - 点赞
     - `moment_comments` - 评论
     - `moment_notifications` - 通知
     - `moment_read_status` - 已读状态

---

## 🚀 部署步骤

### 方式一：推送代码到 GitHub 后自动部署

1. **提交修改：**
```bash
git add .
git commit -m "修复预设房间权限和朋友圈数据库初始化"
git push origin main
```

2. **Railway 自动部署：**
   - Railway 检测到代码更新
   - 自动触发重新构建
   - 使用修复后的 `start.mjs` 初始化数据库
   - 部署完成后，两个问题都会解决

### 方式二：手动触发重新部署

如果已经推送代码但 Railway 没有自动部署：

1. 进入 Railway 控制台
2. 选择你的项目
3. 点击 **"Deployments"** 标签
4. 点击右上角的 **"Redeploy"** 按钮

---

## 🔍 验证修复

### 1. 检查部署日志

在 Railway 的 **Logs** 标签中，应该看到：

```
✅ 主数据库连接成功
✅ 主数据库写入测试成功
✅ 朋友圈数据库连接成功
✅ 朋友圈表结构创建完成
✅ 所有检查通过，启动Nuxt应用...
```

### 2. 测试预设房间

访问你的应用，尝试：
- ✅ 查看预设房间（如 PRESET_TRUMP）的消息
- ✅ 在预设房间发送消息
- ✅ 不需要先加入房间

### 3. 测试朋友圈功能

访问朋友圈页面，应该：
- ✅ 不再出现 "no such table: moments" 错误
- ✅ 可以正常查看朋友圈
- ✅ 可以发布、点赞、评论

---

## 📝 技术细节

### 预设房间判断逻辑

```typescript
// 获取 jerry 用户的 ID
const jerryUser = db.prepare('SELECT id FROM users WHERE username = ?').get('jerry')
const isPresetRoom = jerryUser && room.creator_id === jerryUser.id

// 预设房间跳过成员验证
if (!isPresetRoom) {
  // 检查是否是成员
  const member = db.prepare('SELECT id FROM room_members WHERE room_id = ? AND user_id = ?')
    .get(roomId, user.id)
  
  if (!member) {
    return { success: false, error: '你不是该房间成员' }
  }
}
```

### 朋友圈数据库初始化

```javascript
// 在 start.mjs 中添加
const chatDb = new Database(join(dataDir, 'chat.db'))

// 创建所有朋友圈表
chatDb.exec(`CREATE TABLE IF NOT EXISTS moments (...)`)
chatDb.exec(`CREATE TABLE IF NOT EXISTS moment_likes (...)`)
chatDb.exec(`CREATE TABLE IF NOT EXISTS moment_comments (...)`)
chatDb.exec(`CREATE TABLE IF NOT EXISTS moment_notifications (...)`)
chatDb.exec(`CREATE TABLE IF NOT EXISTS moment_read_status (...)`)
```

---

## ⚠️ 注意事项

1. **数据持久化：**
   - Railway 使用卷（Volume）来持久化 `/app/data` 目录
   - 确保在 Railway 项目设置中已配置卷
   - 数据库文件会在重新部署时保留

2. **环境变量：**
   - 确保已设置 `DEEPSEEK_API_KEY`
   - 建议设置 `SESSION_SECRET`

3. **预设房间：**
   - 预设房间只对由 jerry 用户创建的房间生效
   - 其他用户创建的房间仍需加入才能访问

---

## 🎉 完成

修复完成后，你的应用应该能够：
- ✅ 任何用户都可以访问预设房间
- ✅ 朋友圈功能正常工作
- ✅ 不再出现 500 错误和数据库表不存在错误

如有问题，请检查 Railway 的部署日志。

