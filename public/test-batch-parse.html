<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ‰¹é‡è§£ææ–°é—»äº‹ä»¶ - AIå‰§æœ¬ç”Ÿæˆå™¨</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      color: white;
      margin-bottom: 30px;
    }

    .header h1 {
      font-size: 32px;
      margin-bottom: 10px;
    }

    .header p {
      font-size: 16px;
      opacity: 0.9;
    }

    .main-card {
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }

    .input-group {
      margin-bottom: 20px;
    }

    .input-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
    }

    .input-group input {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.3s;
    }

    .input-group input:focus {
      outline: none;
      border-color: #667eea;
    }

    .button-group {
      display: flex;
      gap: 10px;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      flex: 1;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
    }

    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .btn-secondary {
      background: #f5f5f5;
      color: #333;
      padding: 12px 20px;
    }

    .btn-secondary:hover {
      background: #e0e0e0;
    }

    .status {
      margin-top: 20px;
      padding: 15px;
      border-radius: 8px;
      font-size: 14px;
    }

    .status-loading {
      background: #e3f2fd;
      color: #1976d2;
      border: 2px solid #90caf9;
    }

    .status-success {
      background: #e8f5e9;
      color: #388e3c;
      border: 2px solid #81c784;
    }

    .status-error {
      background: #ffebee;
      color: #c62828;
      border: 2px solid #ef5350;
    }

    .results-container {
      margin-top: 20px;
    }

    .result-item {
      background: #f9f9f9;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 15px;
    }

    .result-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 15px;
      border-bottom: 2px solid #e0e0e0;
    }

    .result-title {
      font-size: 18px;
      font-weight: 700;
      color: #333;
    }

    .result-badge {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .badge-success {
      background: #e8f5e9;
      color: #388e3c;
    }

    .badge-error {
      background: #ffebee;
      color: #c62828;
    }

    .result-section {
      margin-bottom: 15px;
    }

    .result-section h4 {
      font-size: 14px;
      color: #666;
      margin-bottom: 8px;
    }

    .result-section p {
      font-size: 14px;
      color: #333;
      line-height: 1.6;
    }

    .npc-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .npc-item {
      background: white;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 13px;
      border: 1px solid #e0e0e0;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e0e0e0;
      border-radius: 4px;
      overflow: hidden;
      margin-top: 10px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      transition: width 0.3s;
    }

    .hint {
      font-size: 12px;
      color: #666;
      margin-top: 5px;
    }

    .drop-zone {
      border: 3px dashed #667eea;
      border-radius: 12px;
      padding: 40px;
      text-align: center;
      background: #f8f9ff;
      transition: all 0.3s;
      cursor: pointer;
      margin-bottom: 15px;
    }

    .drop-zone:hover {
      background: #f0f2ff;
      border-color: #764ba2;
    }

    .drop-zone.drag-over {
      background: #e8eaff;
      border-color: #764ba2;
      transform: scale(1.02);
    }

    .drop-zone-content {
      pointer-events: none;
    }

    .file-name {
      margin-top: 15px;
      padding: 10px;
      background: white;
      border-radius: 8px;
      font-size: 14px;
      color: #333;
      display: none;
    }

    .file-name.show {
      display: block;
    }

    .export-menu {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .export-menu-content {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      min-width: 300px;
    }

    .summary-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
    }

    .stat-number {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 5px;
    }

    .stat-label {
      font-size: 14px;
      opacity: 0.9;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ¬ AIæ‰¹é‡å‰§æœ¬ç”Ÿæˆå™¨</h1>
      <p>ä»æ–°é—»çƒ­ç‚¹æ‰¹é‡ç”Ÿæˆäº’åŠ¨å‰§æƒ…</p>
    </div>

    <div class="main-card">
      <div class="input-group">
        <label for="jsonFile">ğŸ“ JSONæ–‡ä»¶</label>
        
        <!-- æ‹–æ‹½ä¸Šä¼ åŒºåŸŸ -->
        <div 
          id="dropZone" 
          class="drop-zone"
          ondrop="handleDrop(event)" 
          ondragover="handleDragOver(event)" 
          ondragleave="handleDragLeave(event)"
        >
          <div class="drop-zone-content">
            <span style="font-size: 48px;">ğŸ“„</span>
            <p style="font-size: 16px; font-weight: 600; margin: 10px 0;">æ‹–æ‹½ JSON æ–‡ä»¶åˆ°è¿™é‡Œ</p>
            <p style="font-size: 14px; color: #666;">æˆ–è€…</p>
            <label for="fileInput" class="btn btn-secondary" style="margin-top: 10px; cursor: pointer;">
              ğŸ“‚ é€‰æ‹©æ–‡ä»¶
            </label>
            <input 
              type="file" 
              id="fileInput" 
              accept=".json"
              style="display: none;"
              onchange="handleFileSelect(event)"
            >
          </div>
          <div id="fileName" class="file-name"></div>
        </div>

        <p style="text-align: center; margin: 15px 0; color: #666; font-weight: 600;">â€”â€” æˆ–è¾“å…¥æ–‡ä»¶è·¯å¾„ â€”â€”</p>
        
        <input 
          type="text" 
          id="jsonFile" 
          placeholder="ä¾‹å¦‚: 20251111_10.json (ç›¸å¯¹äºé¡¹ç›®æ ¹ç›®å½•)"
          value="20251111_10.json"
        >
        <p class="hint">ğŸ’¡ æ–‡ä»¶åº”åŒ…å« items æ•°ç»„ï¼Œæ¯ä¸ª item æœ‰ title å’Œ summary å­—æ®µ</p>
      </div>

      <div class="button-group">
        <button class="btn btn-primary" id="parseBtn" onclick="startBatchParse()">
          ğŸš€ å¼€å§‹æ‰¹é‡è§£æ
        </button>
        <button class="btn btn-secondary" id="exportBtn" onclick="showExportMenu()" style="display: none;">
          ğŸ“¥ å¯¼å‡ºç»“æœ
        </button>
        <button class="btn btn-secondary" onclick="clearResults()">
          ğŸ—‘ï¸ æ¸…ç©ºç»“æœ
        </button>
      </div>

      <!-- å¯¼å‡ºèœå• -->
      <div id="exportMenu" class="export-menu" style="display: none;">
        <div class="export-menu-content">
          <h4 style="margin: 0 0 15px 0;">é€‰æ‹©å¯¼å‡ºæ ¼å¼</h4>
          <button class="btn btn-primary" onclick="exportAsJSON()" style="width: 100%; margin-bottom: 10px;">
            ğŸ“„ å¯¼å‡ºä¸º JSON
          </button>
          <button class="btn btn-primary" onclick="exportAsText()" style="width: 100%; margin-bottom: 10px;">
            ğŸ“ å¯¼å‡ºä¸ºæ–‡æœ¬
          </button>
          <button class="btn btn-primary" onclick="exportAsMarkdown()" style="width: 100%; margin-bottom: 10px;">
            ğŸ“‹ å¯¼å‡ºä¸º Markdown
          </button>
          <button class="btn btn-secondary" onclick="hideExportMenu()" style="width: 100%;">
            å–æ¶ˆ
          </button>
        </div>
      </div>

      <div id="status"></div>
      <div id="progress"></div>
    </div>

    <div id="summaryStats"></div>
    <div id="results"></div>
  </div>

  <script>
    let isProcessing = false;
    let results = [];
    let errors = [];
    let uploadedJsonData = null; // å­˜å‚¨ä¸Šä¼ çš„JSONæ•°æ®

    // å¤„ç†æ‹–æ‹½äº‹ä»¶
    function handleDragOver(e) {
      e.preventDefault();
      e.stopPropagation();
      document.getElementById('dropZone').classList.add('drag-over');
    }

    function handleDragLeave(e) {
      e.preventDefault();
      e.stopPropagation();
      document.getElementById('dropZone').classList.remove('drag-over');
    }

    function handleDrop(e) {
      e.preventDefault();
      e.stopPropagation();
      document.getElementById('dropZone').classList.remove('drag-over');

      const files = e.dataTransfer.files;
      if (files.length > 0) {
        const file = files[0];
        if (file.type === 'application/json' || file.name.endsWith('.json')) {
          readJsonFile(file);
        } else {
          alert('è¯·ä¸Šä¼  JSON æ–‡ä»¶ï¼');
        }
      }
    }

    // å¤„ç†æ–‡ä»¶é€‰æ‹©
    function handleFileSelect(e) {
      const files = e.target.files;
      if (files.length > 0) {
        readJsonFile(files[0]);
      }
    }

    // è¯»å–JSONæ–‡ä»¶
    function readJsonFile(file) {
      const reader = new FileReader();
      
      reader.onload = function(e) {
        try {
          const jsonData = JSON.parse(e.target.result);
          uploadedJsonData = jsonData;
          
          // æ˜¾ç¤ºæ–‡ä»¶å
          const fileNameEl = document.getElementById('fileName');
          fileNameEl.innerHTML = `âœ… <strong>å·²é€‰æ‹©æ–‡ä»¶ï¼š</strong>${file.name} (${(file.size / 1024).toFixed(2)} KB)`;
          fileNameEl.classList.add('show');
          
          // æ¸…ç©ºè·¯å¾„è¾“å…¥æ¡†
          document.getElementById('jsonFile').value = '';
          
          console.log('æ–‡ä»¶è¯»å–æˆåŠŸ:', jsonData);
        } catch (error) {
          alert('JSON æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼š' + error.message);
          uploadedJsonData = null;
        }
      };
      
      reader.onerror = function() {
        alert('æ–‡ä»¶è¯»å–å¤±è´¥ï¼');
        uploadedJsonData = null;
      };
      
      reader.readAsText(file);
    }

    async function startBatchParse() {
      if (isProcessing) return;

      const jsonFile = document.getElementById('jsonFile').value.trim();
      const statusEl = document.getElementById('status');
      const resultsEl = document.getElementById('results');
      const progressEl = document.getElementById('progress');
      const summaryStatsEl = document.getElementById('summaryStats');
      const parseBtn = document.getElementById('parseBtn');

      // æ£€æŸ¥æ˜¯å¦æœ‰ä¸Šä¼ çš„æ–‡ä»¶æˆ–è·¯å¾„
      if (!uploadedJsonData && !jsonFile) {
        statusEl.innerHTML = '<div class="status status-error">âŒ è¯·ä¸Šä¼ JSONæ–‡ä»¶æˆ–è¾“å…¥æ–‡ä»¶è·¯å¾„</div>';
        return;
      }

      isProcessing = true;
      parseBtn.disabled = true;
      results = [];
      errors = [];
      resultsEl.innerHTML = '';
      summaryStatsEl.innerHTML = '';
      
      statusEl.innerHTML = '<div class="status status-loading">ğŸ”„ æ­£åœ¨è¯»å–JSONæ–‡ä»¶...</div>';

      try {
        let jsonData;
        
        // ä¼˜å…ˆä½¿ç”¨ä¸Šä¼ çš„æ–‡ä»¶
        if (uploadedJsonData) {
          console.log('ä½¿ç”¨ä¸Šä¼ çš„æ–‡ä»¶æ•°æ®');
          jsonData = uploadedJsonData;
        } else {
          // å¦åˆ™ä»è·¯å¾„è¯»å–
          console.log('ä»è·¯å¾„è¯»å–æ–‡ä»¶:', jsonFile);
          const jsonResponse = await fetch(`/${jsonFile}`);
          if (!jsonResponse.ok) {
            throw new Error(`æ— æ³•è¯»å–æ–‡ä»¶: ${jsonFile}`);
          }
          jsonData = await jsonResponse.json();
        }
        
        if (!jsonData.items || !Array.isArray(jsonData.items)) {
          throw new Error('JSONæ ¼å¼é”™è¯¯ï¼šç¼ºå°‘itemsæ•°ç»„');
        }

        const totalItems = jsonData.items.length;
        
        // æ˜¾ç¤ºåˆå§‹ç»Ÿè®¡
        updateStats(totalItems, 0, 0);
        
        statusEl.innerHTML = `
          <div class="status status-loading">
            ğŸ”„ å¼€å§‹æ‰¹é‡è§£æ... (å…± ${totalItems} ä¸ªäº‹ä»¶)
          </div>
        `;

        // åˆå§‹åŒ–è¿›åº¦æ¡
        progressEl.innerHTML = `
          <div class="progress-bar">
            <div class="progress-fill" style="width: 0%"></div>
          </div>
          <p style="text-align: center; margin-top: 10px; font-size: 14px; color: #666;">
            æ­£åœ¨å¤„ç†: <span id="currentProgress">0</span>/${totalItems}
          </p>
        `;

        // é€ä¸ªå¤„ç†äº‹ä»¶
        for (let i = 0; i < jsonData.items.length; i++) {
          const item = jsonData.items[i];
          const currentNum = i + 1;
          
          // æ›´æ–°çŠ¶æ€
          statusEl.innerHTML = `
            <div class="status status-loading">
              ğŸ”„ æ­£åœ¨è§£æäº‹ä»¶ ${currentNum}/${totalItems}: ${item.title}
            </div>
          `;
          
          // æ›´æ–°è¿›åº¦æ¡
          const progress = (currentNum / totalItems * 100).toFixed(1);
          const progressFill = progressEl.querySelector('.progress-fill');
          const progressText = document.getElementById('currentProgress');
          if (progressFill) progressFill.style.width = progress + '%';
          if (progressText) progressText.textContent = currentNum;

          try {
            // è°ƒç”¨å•ä¸ªäº‹ä»¶è§£æAPI
            const text = `ã€æ ‡é¢˜ã€‘${item.title}\n\nã€è¯¦ç»†å†…å®¹ã€‘\n${item.summary}`;
            
            const response = await fetch('/api/creator/ai-parse', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ text })
            });

            const result = await response.json();

            if (result.success) {
              results.push({
                sourceEvent: {
                  title: item.title,
                  rank: item.rank,
                  query: item.query
                },
                story: result.story,
                npcs: result.npcs,
                reasoning: result.reasoning
              });
              
              // å®æ—¶æ˜¾ç¤ºæˆåŠŸçš„ç»“æœ
              appendResult(results[results.length - 1], results.length);
              
            } else {
              errors.push({
                event: {
                  title: item.title,
                  rank: item.rank,
                  query: item.query
                },
                error: result.error || 'è§£æå¤±è´¥'
              });
            }

          } catch (error) {
            console.error(`è§£æäº‹ä»¶ ${item.title} å¤±è´¥:`, error);
            errors.push({
              event: {
                title: item.title,
                rank: item.rank,
                query: item.query
              },
              error: error.message
            });
          }

          // æ›´æ–°ç»Ÿè®¡
          updateStats(totalItems, results.length, errors.length);

          // æ·»åŠ å»¶è¿Ÿï¼Œé¿å…APIé™æµ
          if (i < jsonData.items.length - 1) {
            await new Promise(resolve => setTimeout(resolve, 1000));
          }
        }

        // å®Œæˆ
        statusEl.innerHTML = `
          <div class="status status-success">
            âœ… æ‰¹é‡è§£æå®Œæˆï¼
            <br>æˆåŠŸ: ${results.length} | å¤±è´¥: ${errors.length}
          </div>
        `;

        // æ˜¾ç¤ºå¯¼å‡ºæŒ‰é’®
        if (results.length > 0) {
          document.getElementById('exportBtn').style.display = 'block';
        }

        // æ˜¾ç¤ºå¤±è´¥çš„ç»“æœ
        if (errors.length > 0) {
          let errorsHtml = '<h2 style="margin: 30px 0 20px 0;">âŒ è§£æå¤±è´¥çš„äº‹ä»¶</h2>';
          errors.forEach((error) => {
            errorsHtml += `
              <div class="result-item">
                <div class="result-header">
                  <div class="result-title">${error.event.title}</div>
                  <span class="result-badge badge-error">âŒ å¤±è´¥</span>
                </div>
                <div class="result-section">
                  <h4>é”™è¯¯ä¿¡æ¯</h4>
                  <p style="color: #c62828;">${error.error}</p>
                </div>
              </div>
            `;
          });
          resultsEl.innerHTML += errorsHtml;
        }

      } catch (error) {
        console.error('æ‰¹é‡è§£æå¤±è´¥:', error);
        statusEl.innerHTML = `
          <div class="status status-error">
            âŒ æ‰¹é‡è§£æå¤±è´¥: ${error.message}
          </div>
        `;
      } finally {
        isProcessing = false;
        parseBtn.disabled = false;
      }
    }

    function updateStats(total, succeeded, failed) {
      const summaryStatsEl = document.getElementById('summaryStats');
      summaryStatsEl.innerHTML = `
        <div class="summary-stats">
          <div class="stat-card">
            <div class="stat-number">${total}</div>
            <div class="stat-label">æ€»äº‹ä»¶æ•°</div>
          </div>
          <div class="stat-card">
            <div class="stat-number">${succeeded}</div>
            <div class="stat-label">è§£ææˆåŠŸ</div>
          </div>
          <div class="stat-card">
            <div class="stat-number">${failed}</div>
            <div class="stat-label">è§£æå¤±è´¥</div>
          </div>
        </div>
      `;
    }

    function appendResult(item, index) {
      const resultsEl = document.getElementById('results');
      
      // å¦‚æœæ˜¯ç¬¬ä¸€ä¸ªç»“æœï¼Œæ·»åŠ æ ‡é¢˜
      if (index === 1) {
        resultsEl.innerHTML = '<h2 style="margin-bottom: 20px;">âœ¨ ç”Ÿæˆçš„å‰§æœ¬</h2>';
      }
      
      const resultHtml = `
        <div class="result-item" id="result-${index}">
          <div class="result-header">
            <div class="result-title">
              ${index}. ${item.story.name}
            </div>
            <span class="result-badge badge-success">âœ… æˆåŠŸ</span>
          </div>
          
          <div class="result-section">
            <h4>ğŸ“° åŸå§‹äº‹ä»¶</h4>
            <p><strong>æ ‡é¢˜:</strong> ${item.sourceEvent.title}</p>
            <p><strong>æ’å:</strong> #${item.sourceEvent.rank} | <strong>æŸ¥è¯¢:</strong> ${item.sourceEvent.query}</p>
          </div>

          <div class="result-section">
            <h4>ğŸ“– å‰§æƒ…ç®€ä»‹</h4>
            <p>${item.story.description}</p>
          </div>

          <div class="result-section">
            <h4>ğŸ­ äº‹ä»¶èƒŒæ™¯</h4>
            <p>${item.story.eventBackground}</p>
          </div>

          <div class="result-section">
            <h4>ğŸ‘¥ è§’è‰²åˆ—è¡¨ (${item.npcs.length}ä¸ª)</h4>
            <div class="npc-list">
              ${item.npcs.map(npc => `
                <div class="npc-item">
                  ${npc.avatar || 'ğŸ‘¤'} ${npc.name} - ${npc.occupation || 'è§’è‰²'}
                </div>
              `).join('')}
            </div>
          </div>

          <div class="result-section">
            <h4>ğŸ’­ è§£æè¯´æ˜</h4>
            <p style="font-size: 13px; color: #666;">${item.reasoning}</p>
          </div>
        </div>
      `;
      
      resultsEl.innerHTML += resultHtml;
      
      // æ»šåŠ¨åˆ°æ–°æ·»åŠ çš„ç»“æœ
      setTimeout(() => {
        const newResult = document.getElementById(`result-${index}`);
        if (newResult) {
          newResult.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
      }, 100);
    }

    function clearResults() {
      document.getElementById('results').innerHTML = '';
      document.getElementById('status').innerHTML = '';
      document.getElementById('progress').innerHTML = '';
      document.getElementById('summaryStats').innerHTML = '';
      document.getElementById('fileName').classList.remove('show');
      document.getElementById('fileName').innerHTML = '';
      document.getElementById('exportBtn').style.display = 'none';
      uploadedJsonData = null;
      results = [];
      errors = [];
    }

    // æ˜¾ç¤º/éšè—å¯¼å‡ºèœå•
    function showExportMenu() {
      document.getElementById('exportMenu').style.display = 'flex';
    }

    function hideExportMenu() {
      document.getElementById('exportMenu').style.display = 'none';
    }

    // å¯¼å‡ºä¸º JSON
    function exportAsJSON() {
      const exportData = {
        exportTime: new Date().toISOString(),
        summary: {
          total: results.length + errors.length,
          succeeded: results.length,
          failed: errors.length
        },
        results: results,
        errors: errors
      };

      const jsonStr = JSON.stringify(exportData, null, 2);
      const blob = new Blob([jsonStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `batch-parse-results-${Date.now()}.json`;
      a.click();
      URL.revokeObjectURL(url);
      
      hideExportMenu();
      alert('âœ… JSON æ–‡ä»¶å·²å¯¼å‡ºï¼');
    }

    // å¯¼å‡ºä¸ºæ–‡æœ¬
    function exportAsText() {
      let text = '=' .repeat(60) + '\n';
      text += 'AI æ‰¹é‡å‰§æœ¬ç”Ÿæˆç»“æœ\n';
      text += '=' .repeat(60) + '\n\n';
      text += `å¯¼å‡ºæ—¶é—´: ${new Date().toLocaleString('zh-CN')}\n`;
      text += `æ€»äº‹ä»¶æ•°: ${results.length + errors.length}\n`;
      text += `æˆåŠŸ: ${results.length} | å¤±è´¥: ${errors.length}\n\n`;

      results.forEach((item, index) => {
        text += '=' .repeat(60) + '\n';
        text += `${index + 1}. ${item.story.name}\n`;
        text += '=' .repeat(60) + '\n\n';
        
        text += 'ã€åŸå§‹äº‹ä»¶ã€‘\n';
        text += `æ ‡é¢˜: ${item.sourceEvent.title}\n`;
        text += `æ’å: #${item.sourceEvent.rank}\n`;
        text += `æŸ¥è¯¢: ${item.sourceEvent.query}\n\n`;
        
        text += 'ã€å‰§æƒ…ç®€ä»‹ã€‘\n';
        text += `${item.story.description}\n\n`;
        
        text += 'ã€äº‹ä»¶èƒŒæ™¯ã€‘\n';
        text += `${item.story.eventBackground}\n\n`;
        
        text += `ã€è§’è‰²åˆ—è¡¨ã€‘(${item.npcs.length}ä¸ª)\n`;
        item.npcs.forEach((npc, i) => {
          text += `${i + 1}. ${npc.avatar || 'ğŸ‘¤'} ${npc.name} - ${npc.occupation || 'è§’è‰²'}\n`;
          text += `   æ€§æ ¼: ${npc.personality}\n`;
          if (npc.background) text += `   èƒŒæ™¯: ${npc.background}\n`;
          if (npc.goals) text += `   ç›®æ ‡: ${npc.goals}\n`;
          text += '\n';
        });
        
        text += 'ã€è§£æè¯´æ˜ã€‘\n';
        text += `${item.reasoning}\n\n`;
      });

      if (errors.length > 0) {
        text += '=' .repeat(60) + '\n';
        text += 'å¤±è´¥çš„äº‹ä»¶\n';
        text += '=' .repeat(60) + '\n\n';
        errors.forEach((error, index) => {
          text += `${index + 1}. ${error.event.title}\n`;
          text += `   é”™è¯¯: ${error.error}\n\n`;
        });
      }

      const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `batch-parse-results-${Date.now()}.txt`;
      a.click();
      URL.revokeObjectURL(url);
      
      hideExportMenu();
      alert('âœ… æ–‡æœ¬æ–‡ä»¶å·²å¯¼å‡ºï¼');
    }

    // å¯¼å‡ºä¸º Markdown
    function exportAsMarkdown() {
      let md = '# AI æ‰¹é‡å‰§æœ¬ç”Ÿæˆç»“æœ\n\n';
      md += `**å¯¼å‡ºæ—¶é—´:** ${new Date().toLocaleString('zh-CN')}\n\n`;
      md += `**ç»Ÿè®¡ä¿¡æ¯:**\n`;
      md += `- æ€»äº‹ä»¶æ•°: ${results.length + errors.length}\n`;
      md += `- æˆåŠŸ: ${results.length}\n`;
      md += `- å¤±è´¥: ${errors.length}\n\n`;
      md += '---\n\n';

      results.forEach((item, index) => {
        md += `## ${index + 1}. ${item.story.name}\n\n`;
        
        md += '### ğŸ“° åŸå§‹äº‹ä»¶\n\n';
        md += `- **æ ‡é¢˜:** ${item.sourceEvent.title}\n`;
        md += `- **æ’å:** #${item.sourceEvent.rank}\n`;
        md += `- **æŸ¥è¯¢:** ${item.sourceEvent.query}\n\n`;
        
        md += '### ğŸ“– å‰§æƒ…ç®€ä»‹\n\n';
        md += `${item.story.description}\n\n`;
        
        md += '### ğŸ­ äº‹ä»¶èƒŒæ™¯\n\n';
        md += `${item.story.eventBackground}\n\n`;
        
        md += `### ğŸ‘¥ è§’è‰²åˆ—è¡¨ (${item.npcs.length}ä¸ª)\n\n`;
        item.npcs.forEach((npc, i) => {
          md += `#### ${i + 1}. ${npc.avatar || 'ğŸ‘¤'} ${npc.name}\n\n`;
          md += `- **èŒä¸š:** ${npc.occupation || 'æœªçŸ¥'}\n`;
          md += `- **æ€§æ ¼:** ${npc.personality}\n`;
          if (npc.background) md += `- **èƒŒæ™¯:** ${npc.background}\n`;
          if (npc.goals) md += `- **ç›®æ ‡:** ${npc.goals}\n`;
          if (npc.skills) md += `- **æŠ€èƒ½:** ${npc.skills}\n`;
          md += '\n';
        });
        
        md += '### ğŸ’­ è§£æè¯´æ˜\n\n';
        md += `${item.reasoning}\n\n`;
        md += '---\n\n';
      });

      if (errors.length > 0) {
        md += '## âŒ å¤±è´¥çš„äº‹ä»¶\n\n';
        errors.forEach((error, index) => {
          md += `${index + 1}. **${error.event.title}**\n`;
          md += `   - é”™è¯¯: ${error.error}\n\n`;
        });
      }

      const blob = new Blob([md], { type: 'text/markdown;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `batch-parse-results-${Date.now()}.md`;
      a.click();
      URL.revokeObjectURL(url);
      
      hideExportMenu();
      alert('âœ… Markdown æ–‡ä»¶å·²å¯¼å‡ºï¼');
    }
  </script>
</body>
</html>

