<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æœ‹å‹åœˆæ—¶é—´æµ‹è¯•</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      max-width: 900px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    h1 {
      color: #333;
      border-bottom: 3px solid #07c160;
      padding-bottom: 10px;
    }
    .section {
      background: white;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .info-row {
      display: flex;
      justify-content: space-between;
      padding: 10px;
      border-bottom: 1px solid #eee;
    }
    .label {
      font-weight: bold;
      color: #666;
    }
    .value {
      color: #333;
      font-family: monospace;
    }
    button {
      background: #07c160;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      margin: 10px 5px;
    }
    button:hover {
      background: #06ad56;
    }
    .moment-item {
      background: #f9f9f9;
      padding: 15px;
      margin: 10px 0;
      border-radius: 8px;
      border-left: 4px solid #07c160;
    }
    .moment-author {
      font-weight: bold;
      color: #333;
      margin-bottom: 8px;
    }
    .moment-content {
      color: #666;
      margin-bottom: 8px;
    }
    .moment-time {
      color: #999;
      font-size: 14px;
    }
    .moment-raw-time {
      color: #666;
      font-size: 12px;
      font-family: monospace;
      margin-top: 4px;
      padding: 4px 8px;
      background: #fff;
      border-radius: 4px;
    }
    .error {
      color: red;
      padding: 10px;
      background: #fee;
      border-radius: 4px;
      margin: 10px 0;
    }
    .success {
      color: green;
      padding: 10px;
      background: #efe;
      border-radius: 4px;
      margin: 10px 0;
    }
  </style>
</head>
<body>
  <h1>ğŸ• æœ‹å‹åœˆæ—¶é—´è½¬æ¢æµ‹è¯•</h1>

  <div class="section">
    <h2>ğŸ“Š ç³»ç»Ÿä¿¡æ¯</h2>
    <div class="info-row">
      <span class="label">æµè§ˆå™¨æœ¬åœ°æ—¶é—´ï¼š</span>
      <span class="value" id="localTime"></span>
    </div>
    <div class="info-row">
      <span class="label">æµè§ˆå™¨æ—¶åŒºåç§»ï¼š</span>
      <span class="value" id="timezoneOffset"></span>
    </div>
    <div class="info-row">
      <span class="label">å½“å‰åŒ—äº¬æ—¶é—´ï¼ˆè®¡ç®—ï¼‰ï¼š</span>
      <span class="value" id="beijingTime"></span>
    </div>
  </div>

  <div class="section">
    <h2>ğŸ§ª SQLite æ—¶é—´æ ¼å¼æµ‹è¯•</h2>
    <div id="sqliteTest"></div>
  </div>

  <div class="section">
    <h2>ğŸ“ è·å–æœ€æ–°æœ‹å‹åœˆ</h2>
    <button onclick="fetchMoments()">è·å–æœ‹å‹åœˆæ•°æ®</button>
    <div id="momentsResult"></div>
  </div>

  <script>
    // æ›´æ–°ç³»ç»Ÿä¿¡æ¯
    function updateSystemInfo() {
      const now = new Date()
      document.getElementById('localTime').textContent = now.toLocaleString('zh-CN')
      document.getElementById('timezoneOffset').textContent = `UTC${now.getTimezoneOffset() > 0 ? '-' : '+'}${Math.abs(now.getTimezoneOffset() / 60)}`
      
      // è®¡ç®—åŒ—äº¬æ—¶é—´
      const beijingTime = new Date(now.getTime() + 8 * 60 * 60 * 1000)
      document.getElementById('beijingTime').textContent = beijingTime.toISOString().replace('T', ' ').substring(0, 19)
    }

    // æµ‹è¯• SQLite æ—¶é—´æ ¼å¼è½¬æ¢
    function testSQLiteFormat() {
      const testCases = [
        { 
          input: '2025-11-05 09:28:32', 
          desc: 'SQLite CURRENT_TIMESTAMP æ ¼å¼ (å‡è®¾ä¸º UTC)'
        },
        { 
          input: new Date().toISOString().substring(0, 19).replace('T', ' '), 
          desc: 'å½“å‰ UTC æ—¶é—´ (SQLite æ ¼å¼)'
        }
      ]

      let html = ''
      testCases.forEach((test, index) => {
        // æ–¹æ³•1ï¼šç›´æ¥ new Dateï¼ˆé”™è¯¯ï¼Œä¼šå½“æˆæœ¬åœ°æ—¶é—´ï¼‰
        const wrong = new Date(test.input)
        
        // æ–¹æ³•2ï¼šæ·»åŠ  Z æ ‡è®°ä¸º UTCï¼ˆæ­£ç¡®ï¼‰
        const correct = new Date(test.input.replace(' ', 'T') + 'Z')
        
        // è½¬æ¢ä¸ºåŒ—äº¬æ—¶é—´
        const beijingTime = new Date(correct.getTime() + 8 * 60 * 60 * 1000)
        
        // è®¡ç®—ç›¸å¯¹æ—¶é—´
        const now = new Date(Date.now() + 8 * 60 * 60 * 1000)
        const diff = now.getTime() - beijingTime.getTime()
        const minutes = Math.floor(diff / 60000)
        const hours = Math.floor(minutes / 60)
        const days = Math.floor(hours / 24)
        
        let relativeTime = 'æœªçŸ¥'
        if (minutes < 1) relativeTime = 'åˆšåˆš'
        else if (minutes < 60) relativeTime = `${minutes}åˆ†é’Ÿå‰`
        else if (hours < 24) relativeTime = `${hours}å°æ—¶å‰`
        else if (days < 7) relativeTime = `${days}å¤©å‰`
        else relativeTime = beijingTime.toISOString().substring(0, 10)

        html += `
          <div class="moment-item">
            <div class="moment-author">æµ‹è¯•æ¡ˆä¾‹ ${index + 1}: ${test.desc}</div>
            <div class="moment-raw-time">åŸå§‹: ${test.input}</div>
            <div class="moment-raw-time">âŒ é”™è¯¯è§£æ (new Date): ${wrong.toLocaleString('zh-CN')}</div>
            <div class="moment-raw-time">âœ… æ­£ç¡®è§£æ (UTC): ${correct.toISOString()}</div>
            <div class="moment-raw-time">âœ… åŒ—äº¬æ—¶é—´: ${beijingTime.toISOString().replace('T', ' ').substring(0, 19)}</div>
            <div class="moment-time">æ˜¾ç¤º: ${relativeTime}</div>
          </div>
        `
      })

      document.getElementById('sqliteTest').innerHTML = html
    }

    // è·å–æœ‹å‹åœˆæ•°æ®
    async function fetchMoments() {
      const resultDiv = document.getElementById('momentsResult')
      resultDiv.innerHTML = '<p>åŠ è½½ä¸­...</p>'

      try {
        const response = await fetch('/api/moments/recent')
        const data = await response.json()

        if (!data.success) {
          resultDiv.innerHTML = `<div class="error">âŒ è·å–å¤±è´¥: ${data.error || 'æœªçŸ¥é”™è¯¯'}</div>`
          return
        }

        if (!data.moments || data.moments.length === 0) {
          resultDiv.innerHTML = '<div class="success">âœ… æ•°æ®è·å–æˆåŠŸï¼Œä½†æ²¡æœ‰æœ‹å‹åœˆ</div>'
          return
        }

        let html = `<div class="success">âœ… è·å–åˆ° ${data.moments.length} æ¡æœ‹å‹åœˆ</div>`

        data.moments.forEach((moment, index) => {
          // è§£ææ—¶é—´
          let created_at = moment.created_at
          let targetUtc
          
          if (typeof created_at === 'string') {
            if (created_at.includes(' ') && !created_at.includes('T') && !created_at.includes('Z')) {
              targetUtc = new Date(created_at.replace(' ', 'T') + 'Z')
            } else {
              targetUtc = new Date(created_at)
            }
          } else {
            targetUtc = new Date(created_at)
          }

          const beijingTime = new Date(targetUtc.getTime() + 8 * 60 * 60 * 1000)
          const now = new Date(Date.now() + 8 * 60 * 60 * 1000)
          const diff = now.getTime() - beijingTime.getTime()
          
          const minutes = Math.floor(diff / 60000)
          const hours = Math.floor(minutes / 60)
          const days = Math.floor(hours / 24)
          
          let relativeTime = 'æœªçŸ¥'
          if (diff < 0) relativeTime = 'åˆšåˆš'
          else if (minutes < 1) relativeTime = 'åˆšåˆš'
          else if (minutes < 60) relativeTime = `${minutes}åˆ†é’Ÿå‰`
          else if (hours < 24) relativeTime = `${hours}å°æ—¶å‰`
          else if (days === 1) relativeTime = 'æ˜¨å¤©'
          else if (days < 7) relativeTime = `${days}å¤©å‰`
          else relativeTime = beijingTime.toISOString().substring(0, 10)

          const author = moment.npc_name || moment.user_nickname || moment.user_name || 'æœªçŸ¥'

          html += `
            <div class="moment-item">
              <div class="moment-author">${index + 1}. ${author}</div>
              <div class="moment-content">${moment.content}</div>
              <div class="moment-raw-time">æ•°æ®åº“åŸå§‹æ—¶é—´: ${created_at}</div>
              <div class="moment-raw-time">è§£æä¸ºUTC: ${targetUtc.toISOString()}</div>
              <div class="moment-raw-time">è½¬æ¢ä¸ºåŒ—äº¬æ—¶é—´: ${beijingTime.toISOString().replace('T', ' ').substring(0, 19)}</div>
              <div class="moment-raw-time">æ—¶é—´å·®: ${Math.floor(diff / 1000)}ç§’ = ${minutes}åˆ†é’Ÿ = ${hours}å°æ—¶ = ${days}å¤©</div>
              <div class="moment-time">å‰ç«¯æ˜¾ç¤º: ${relativeTime}</div>
            </div>
          `
        })

        resultDiv.innerHTML = html
      } catch (error) {
        resultDiv.innerHTML = `<div class="error">âŒ è¯·æ±‚å¤±è´¥: ${error.message}</div>`
      }
    }

    // åˆå§‹åŒ–
    updateSystemInfo()
    testSQLiteFormat()
    setInterval(updateSystemInfo, 1000)

    console.log('âœ… æµ‹è¯•é¡µé¢å·²åŠ è½½')
    console.log('ğŸ’¡ ç‚¹å‡»æŒ‰é’®è·å–æœ‹å‹åœˆæ•°æ®è¿›è¡Œæµ‹è¯•')
  </script>
</body>
</html>

