<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æˆ¿é—´åŠ è½½æµ‹è¯•</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .test-section {
      background: white;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .btn {
      background: #07c160;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 10px;
    }
    .btn:hover {
      background: #06ad56;
    }
    .result {
      margin-top: 15px;
      padding: 15px;
      background: #f8f8f8;
      border-radius: 4px;
      white-space: pre-wrap;
      word-break: break-all;
    }
    .success { color: #07c160; }
    .error { color: #ff4757; }
    .warning { color: #ffa502; }
  </style>
</head>
<body>
  <h1>ğŸ” æˆ¿é—´åŠ è½½è¯Šæ–­å·¥å…·</h1>
  
  <div class="test-section">
    <h2>1ï¸âƒ£ æ£€æŸ¥ä¼šè¯çŠ¶æ€</h2>
    <button class="btn" onclick="checkSession()">æ£€æŸ¥ç™»å½•çŠ¶æ€</button>
    <div id="sessionResult" class="result">ç‚¹å‡»æŒ‰é’®å¼€å§‹æ£€æŸ¥...</div>
  </div>
  
  <div class="test-section">
    <h2>2ï¸âƒ£ æµ‹è¯•é¢„è®¾æˆ¿é—´API</h2>
    <button class="btn" onclick="testPresetRooms()">åŠ è½½é¢„è®¾æˆ¿é—´</button>
    <div id="presetResult" class="result">ç‚¹å‡»æŒ‰é’®å¼€å§‹æµ‹è¯•...</div>
  </div>
  
  <div class="test-section">
    <h2>3ï¸âƒ£ æµ‹è¯•æˆ‘çš„æˆ¿é—´API</h2>
    <button class="btn" onclick="testMyRooms()">åŠ è½½æˆ‘çš„æˆ¿é—´</button>
    <div id="myRoomsResult" class="result">ç‚¹å‡»æŒ‰é’®å¼€å§‹æµ‹è¯•...</div>
  </div>
  
  <div class="test-section">
    <h2>4ï¸âƒ£ ä¸€é”®è¯Šæ–­</h2>
    <button class="btn" onclick="runFullDiagnostic()">è¿è¡Œå®Œæ•´è¯Šæ–­</button>
    <div id="diagnosticResult" class="result">ç‚¹å‡»æŒ‰é’®å¼€å§‹å®Œæ•´è¯Šæ–­...</div>
  </div>

  <script>
    async function checkSession() {
      const result = document.getElementById('sessionResult');
      result.innerHTML = 'â³ æ­£åœ¨æ£€æŸ¥...';
      
      try {
        const response = await fetch('/api/auth/session');
        const data = await response.json();
        
        if (data.success && data.user) {
          result.innerHTML = `<span class="success">âœ… å·²ç™»å½•</span>\n\nç”¨æˆ·ä¿¡æ¯ï¼š\n${JSON.stringify(data.user, null, 2)}`;
        } else {
          result.innerHTML = `<span class="error">âŒ æœªç™»å½•</span>\n\n${JSON.stringify(data, null, 2)}\n\n<span class="warning">ğŸ’¡ æç¤ºï¼šè¯·å…ˆç™»å½• http://localhost:3001/login</span>`;
        }
      } catch (error) {
        result.innerHTML = `<span class="error">âŒ è¯·æ±‚å¤±è´¥</span>\n\né”™è¯¯ä¿¡æ¯ï¼š${error.message}`;
      }
    }
    
    async function testPresetRooms() {
      const result = document.getElementById('presetResult');
      result.innerHTML = 'â³ æ­£åœ¨åŠ è½½...';
      
      try {
        const response = await fetch('/api/rooms/preset-rooms');
        const data = await response.json();
        
        if (data.success) {
          result.innerHTML = `<span class="success">âœ… åŠ è½½æˆåŠŸ</span>\n\næ‰¾åˆ° ${data.rooms.length} ä¸ªé¢„è®¾æˆ¿é—´ï¼š\n\n`;
          data.rooms.forEach((room, index) => {
            result.innerHTML += `${index + 1}. ${room.name} ${room.avatar}\n   æè¿°ï¼š${room.description}\n   æˆå‘˜ï¼š${room.players}\n\n`;
          });
        } else {
          result.innerHTML = `<span class="error">âŒ åŠ è½½å¤±è´¥</span>\n\n${JSON.stringify(data, null, 2)}`;
        }
      } catch (error) {
        result.innerHTML = `<span class="error">âŒ è¯·æ±‚å¤±è´¥</span>\n\né”™è¯¯ä¿¡æ¯ï¼š${error.message}`;
      }
    }
    
    async function testMyRooms() {
      const result = document.getElementById('myRoomsResult');
      result.innerHTML = 'â³ æ­£åœ¨åŠ è½½...';
      
      try {
        const response = await fetch('/api/rooms/my-rooms');
        const data = await response.json();
        
        if (data.success) {
          if (data.rooms.length === 0) {
            result.innerHTML = `<span class="warning">âš ï¸ è¿˜æ²¡æœ‰åŠ å…¥ä»»ä½•æˆ¿é—´</span>`;
          } else {
            result.innerHTML = `<span class="success">âœ… åŠ è½½æˆåŠŸ</span>\n\næ‰¾åˆ° ${data.rooms.length} ä¸ªæˆ¿é—´ï¼š\n\n`;
            data.rooms.forEach((room, index) => {
              result.innerHTML += `${index + 1}. ${room.name}\n   æˆå‘˜ï¼š${room.players}\n\n`;
            });
          }
        } else {
          result.innerHTML = `<span class="error">âŒ åŠ è½½å¤±è´¥</span>\n\n${JSON.stringify(data, null, 2)}`;
        }
      } catch (error) {
        result.innerHTML = `<span class="error">âŒ è¯·æ±‚å¤±è´¥</span>\n\né”™è¯¯ä¿¡æ¯ï¼š${error.message}`;
      }
    }
    
    async function runFullDiagnostic() {
      const result = document.getElementById('diagnosticResult');
      result.innerHTML = 'â³ æ­£åœ¨è¿è¡Œå®Œæ•´è¯Šæ–­...\n\n';
      
      let report = 'ğŸ“‹ è¯Šæ–­æŠ¥å‘Š\n';
      report += '=' .repeat(50) + '\n\n';
      
      // 1. æ£€æŸ¥ä¼šè¯
      result.innerHTML += '1ï¸âƒ£ æ£€æŸ¥ç™»å½•çŠ¶æ€...\n';
      try {
        const sessionRes = await fetch('/api/auth/session');
        const sessionData = await sessionRes.json();
        if (sessionData.success && sessionData.user) {
          report += 'âœ… ç™»å½•çŠ¶æ€ï¼šå·²ç™»å½•\n';
          report += `   ç”¨æˆ·ï¼š${sessionData.user.nickname} (@${sessionData.user.username})\n\n`;
        } else {
          report += 'âŒ ç™»å½•çŠ¶æ€ï¼šæœªç™»å½•\n';
          report += '   å»ºè®®ï¼šè¯·å…ˆè®¿é—® /login ç™»å½•\n\n';
        }
      } catch (e) {
        report += `âŒ ç™»å½•æ£€æŸ¥å¤±è´¥ï¼š${e.message}\n\n`;
      }
      
      // 2. æ£€æŸ¥é¢„è®¾æˆ¿é—´
      result.innerHTML += '2ï¸âƒ£ æ£€æŸ¥é¢„è®¾æˆ¿é—´...\n';
      try {
        const presetRes = await fetch('/api/rooms/preset-rooms');
        const presetData = await presetRes.json();
        if (presetData.success) {
          report += `âœ… é¢„è®¾æˆ¿é—´ï¼š${presetData.rooms.length} ä¸ª\n`;
          presetData.rooms.forEach(room => {
            report += `   - ${room.name} (${room.players})\n`;
          });
          report += '\n';
        } else {
          report += 'âŒ é¢„è®¾æˆ¿é—´åŠ è½½å¤±è´¥\n\n';
        }
      } catch (e) {
        report += `âŒ é¢„è®¾æˆ¿é—´æ£€æŸ¥å¤±è´¥ï¼š${e.message}\n\n`;
      }
      
      // 3. æ£€æŸ¥æˆ‘çš„æˆ¿é—´
      result.innerHTML += '3ï¸âƒ£ æ£€æŸ¥æˆ‘çš„æˆ¿é—´...\n';
      try {
        const myRes = await fetch('/api/rooms/my-rooms');
        const myData = await myRes.json();
        if (myData.success) {
          report += `âœ… æˆ‘çš„æˆ¿é—´ï¼š${myData.rooms.length} ä¸ª\n\n`;
        } else {
          report += 'âŒ æˆ‘çš„æˆ¿é—´åŠ è½½å¤±è´¥\n\n';
        }
      } catch (e) {
        report += `âŒ æˆ‘çš„æˆ¿é—´æ£€æŸ¥å¤±è´¥ï¼š${e.message}\n\n`;
      }
      
      report += '=' .repeat(50) + '\n';
      report += '\nğŸ’¡ å»ºè®®ï¼š\n';
      report += '  1. ç¡®ä¿å·²ç™»å½•ï¼ˆä½¿ç”¨ jerry / 123123ï¼‰\n';
      report += '  2. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜åé‡è¯•\n';
      report += '  3. æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰JavaScripté”™è¯¯\n';
      
      result.innerHTML = report;
    }
  </script>
</body>
</html>

