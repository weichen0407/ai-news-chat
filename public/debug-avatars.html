<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¤´åƒè¯Šæ–­å·¥å…·</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      max-width: 1200px;
      margin: 40px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 2rem;
      border-radius: 12px;
      margin-bottom: 2rem;
      text-align: center;
    }
    
    .section {
      background: white;
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .section h2 {
      margin-top: 0;
      color: #333;
      border-bottom: 2px solid #667eea;
      padding-bottom: 0.5rem;
    }
    
    button {
      background: #667eea;
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1rem;
      margin-right: 0.5rem;
      margin-bottom: 0.5rem;
    }
    
    button:hover {
      background: #5568d3;
    }
    
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    .result {
      background: #f8f9fa;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      padding: 1rem;
      margin-top: 1rem;
      font-family: monospace;
      white-space: pre-wrap;
      max-height: 400px;
      overflow-y: auto;
    }
    
    .avatar-test {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1rem;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      margin-bottom: 0.5rem;
      background: white;
    }
    
    .avatar-preview {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: #f0f0f0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      overflow: hidden;
      flex-shrink: 0;
    }
    
    .avatar-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .avatar-info {
      flex: 1;
      min-width: 0;
    }
    
    .avatar-name {
      font-weight: 600;
      margin-bottom: 0.25rem;
    }
    
    .avatar-type {
      font-size: 0.875rem;
      color: #666;
      word-break: break-all;
    }
    
    .status {
      padding: 0.25rem 0.75rem;
      border-radius: 4px;
      font-size: 0.875rem;
      font-weight: 600;
    }
    
    .status.success {
      background: #d4edda;
      color: #155724;
    }
    
    .status.error {
      background: #f8d7da;
      color: #721c24;
    }
    
    .status.warning {
      background: #fff3cd;
      color: #856404;
    }
    
    .loading {
      text-align: center;
      padding: 2rem;
      color: #667eea;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>ğŸ” å¤´åƒè¯Šæ–­å·¥å…·</h1>
    <p>æ£€æŸ¥å„ä¸ªé¡µé¢çš„å¤´åƒæ˜¾ç¤ºé—®é¢˜</p>
  </div>

  <div class="section">
    <h2>ğŸ“Š 1. ç™»å½•çŠ¶æ€æ£€æŸ¥</h2>
    <button onclick="checkLogin()">æ£€æŸ¥ç™»å½•çŠ¶æ€</button>
    <div id="loginResult" class="result" style="display:none;"></div>
  </div>

  <div class="section">
    <h2>ğŸ‘¥ 2. è”ç³»äººå¤´åƒæ£€æŸ¥</h2>
    <button onclick="checkContacts()">æ£€æŸ¥è”ç³»äººAPI</button>
    <div id="contactsResult" class="result" style="display:none;"></div>
    <div id="contactsAvatars"></div>
  </div>

  <div class="section">
    <h2>ğŸ­ 3. æœ‹å‹åœˆå¤´åƒæ£€æŸ¥</h2>
    <button onclick="checkMoments()">æ£€æŸ¥æœ‹å‹åœˆAPI</button>
    <div id="momentsResult" class="result" style="display:none;"></div>
    <div id="momentsAvatars"></div>
  </div>

  <div class="section">
    <h2>ğŸ’¬ 4. èŠå¤©æ¶ˆæ¯å¤´åƒæ£€æŸ¥</h2>
    <input type="text" id="roomId" placeholder="è¾“å…¥æˆ¿é—´IDï¼ˆå¦‚ PRESET_WBQï¼‰" style="padding: 0.5rem; margin-right: 0.5rem; width: 300px;">
    <button onclick="checkMessages()">æ£€æŸ¥èŠå¤©API</button>
    <div id="messagesResult" class="result" style="display:none;"></div>
    <div id="messagesAvatars"></div>
  </div>

  <div class="section">
    <h2>ğŸ§ª 5. å¤´åƒURLæµ‹è¯•</h2>
    <input type="text" id="testUrl" placeholder="è¾“å…¥å¤´åƒURLæˆ–base64" style="padding: 0.5rem; margin-right: 0.5rem; width: 500px;">
    <button onclick="testAvatarUrl()">æµ‹è¯•</button>
    <div id="testResult"></div>
  </div>

  <script>
    let currentUser = null;

    // è¾…åŠ©å‡½æ•°ï¼šåˆ¤æ–­æ˜¯å¦ä¸ºå›¾ç‰‡URL
    function isImageAvatar(avatar) {
      if (!avatar) return false;
      return avatar.startsWith('data:image') || 
             avatar.startsWith('http://') || 
             avatar.startsWith('https://');
    }

    // è¾…åŠ©å‡½æ•°ï¼šæ¸²æŸ“å¤´åƒ
    function renderAvatar(avatar, name) {
      const div = document.createElement('div');
      div.className = 'avatar-test';
      
      const preview = document.createElement('div');
      preview.className = 'avatar-preview';
      
      if (isImageAvatar(avatar)) {
        const img = document.createElement('img');
        img.src = avatar;
        img.alt = name;
        img.onerror = function() {
          preview.innerHTML = 'âŒ';
          preview.style.background = '#ffebee';
        };
        img.onload = function() {
          const status = document.getElementById(`status-${name}`);
          if (status) status.className = 'status success';
          if (status) status.textContent = 'âœ… åŠ è½½æˆåŠŸ';
        };
        preview.appendChild(img);
      } else {
        preview.textContent = avatar || 'ğŸ‘¤';
      }
      
      const info = document.createElement('div');
      info.className = 'avatar-info';
      info.innerHTML = `
        <div class="avatar-name">${name}</div>
        <div class="avatar-type">${avatar ? (isImageAvatar(avatar) ? `å›¾ç‰‡: ${avatar.substring(0, 60)}...` : `Emoji: ${avatar}`) : 'ç©ºå¤´åƒ'}</div>
      `;
      
      const status = document.createElement('span');
      status.id = `status-${name}`;
      status.className = isImageAvatar(avatar) ? 'status warning' : 'status success';
      status.textContent = isImageAvatar(avatar) ? 'â³ åŠ è½½ä¸­...' : 'âœ… ç›´æ¥æ˜¾ç¤º';
      
      div.appendChild(preview);
      div.appendChild(info);
      div.appendChild(status);
      
      return div;
    }

    // 1. æ£€æŸ¥ç™»å½•çŠ¶æ€
    async function checkLogin() {
      const resultDiv = document.getElementById('loginResult');
      resultDiv.style.display = 'block';
      resultDiv.textContent = 'â³ æ£€æŸ¥ä¸­...';
      
      try {
        const response = await fetch('/api/auth/session');
        const data = await response.json();
        
        if (data.success && data.user) {
          currentUser = data.user;
          resultDiv.textContent = `âœ… å·²ç™»å½•\nç”¨æˆ·ID: ${data.user.id}\nç”¨æˆ·å: ${data.user.username}\næ˜µç§°: ${data.user.nickname}\nå¤´åƒ: ${data.user.avatar ? data.user.avatar.substring(0, 60) + '...' : 'æ— '}`;
        } else {
          resultDiv.textContent = 'âŒ æœªç™»å½•æˆ–ä¼šè¯å·²è¿‡æœŸ';
        }
      } catch (error) {
        resultDiv.textContent = `âŒ é”™è¯¯: ${error.message}`;
      }
    }

    // 2. æ£€æŸ¥è”ç³»äºº
    async function checkContacts() {
      const resultDiv = document.getElementById('contactsResult');
      const avatarsDiv = document.getElementById('contactsAvatars');
      resultDiv.style.display = 'block';
      resultDiv.textContent = 'â³ æ£€æŸ¥ä¸­...';
      avatarsDiv.innerHTML = '';
      
      try {
        const response = await fetch('/api/contacts/list');
        const data = await response.json();
        
        if (data.success) {
          resultDiv.textContent = `âœ… æˆåŠŸè·å– ${data.contacts.length} ä¸ªè”ç³»äºº`;
          
          data.contacts.forEach(contact => {
            avatarsDiv.appendChild(renderAvatar(contact.avatar, contact.name));
          });
        } else {
          resultDiv.textContent = `âŒ å¤±è´¥: ${data.error}`;
        }
      } catch (error) {
        resultDiv.textContent = `âŒ é”™è¯¯: ${error.message}`;
      }
    }

    // 3. æ£€æŸ¥æœ‹å‹åœˆ
    async function checkMoments() {
      const resultDiv = document.getElementById('momentsResult');
      const avatarsDiv = document.getElementById('momentsAvatars');
      resultDiv.style.display = 'block';
      resultDiv.textContent = 'â³ æ£€æŸ¥ä¸­...';
      avatarsDiv.innerHTML = '';
      
      try {
        const response = await fetch('/api/moments/friends');
        const data = await response.json();
        
        if (data.success) {
          resultDiv.textContent = `âœ… æˆåŠŸè·å– ${data.moments.length} æ¡æœ‹å‹åœˆ`;
          
          data.moments.forEach(moment => {
            const avatar = moment.user_avatar || moment.npc_avatar;
            const name = moment.user_nickname || moment.npc_name;
            avatarsDiv.appendChild(renderAvatar(avatar, name));
          });
        } else {
          resultDiv.textContent = `âŒ å¤±è´¥: ${data.error}`;
        }
      } catch (error) {
        resultDiv.textContent = `âŒ é”™è¯¯: ${error.message}`;
      }
    }

    // 4. æ£€æŸ¥èŠå¤©æ¶ˆæ¯
    async function checkMessages() {
      const roomId = document.getElementById('roomId').value;
      if (!roomId) {
        alert('è¯·è¾“å…¥æˆ¿é—´ID');
        return;
      }
      
      const resultDiv = document.getElementById('messagesResult');
      const avatarsDiv = document.getElementById('messagesAvatars');
      resultDiv.style.display = 'block';
      resultDiv.textContent = 'â³ æ£€æŸ¥ä¸­...';
      avatarsDiv.innerHTML = '';
      
      try {
        const response = await fetch(`/api/rooms/${roomId}/messages`);
        const data = await response.json();
        
        if (data.success) {
          resultDiv.textContent = `âœ… æˆåŠŸè·å– ${data.messages.length} æ¡æ¶ˆæ¯`;
          
          // å»é‡å¤´åƒ
          const seen = new Set();
          data.messages.forEach(msg => {
            const key = `${msg.sender_name}-${msg.avatar}`;
            if (!seen.has(key)) {
              seen.add(key);
              avatarsDiv.appendChild(renderAvatar(msg.avatar, msg.sender_name));
            }
          });
        } else {
          resultDiv.textContent = `âŒ å¤±è´¥: ${data.error}`;
        }
      } catch (error) {
        resultDiv.textContent = `âŒ é”™è¯¯: ${error.message}`;
      }
    }

    // 5. æµ‹è¯•å¤´åƒURL
    function testAvatarUrl() {
      const url = document.getElementById('testUrl').value;
      const resultDiv = document.getElementById('testResult');
      
      if (!url) {
        alert('è¯·è¾“å…¥å¤´åƒURL');
        return;
      }
      
      resultDiv.innerHTML = '';
      resultDiv.appendChild(renderAvatar(url, 'æµ‹è¯•å¤´åƒ'));
    }

    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥ç™»å½•
    window.addEventListener('load', () => {
      checkLogin();
    });
  </script>
</body>
</html>

