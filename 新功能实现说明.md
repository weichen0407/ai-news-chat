# æ–°åŠŸèƒ½å®ç°è¯´æ˜

## å®Œæˆçš„åŠŸèƒ½

### 1ï¸âƒ£ ä¿®å¤NPCå›å¤è¯„è®ºçš„é—®é¢˜ âœ…

**é—®é¢˜æè¿°ï¼š**
- ç©å®¶å›å¤NPCçš„è¯„è®ºåï¼Œå…¶ä»–NPCä¸å›å¤

**ä¿®å¤å†…å®¹ï¼š**
- ä¿®æ”¹äº† `server/api/moments/comment.post.ts` ä¸­çš„ `triggerNPCAutoReply` å‡½æ•°
- å¢åŠ äº†ä¸‰ç§æƒ…å†µçš„åˆ¤æ–­ï¼š
  1. å¦‚æœç©å®¶å›å¤çš„æ˜¯NPCè¯„è®º â†’ è§¦å‘è¯¥NPCæ‰€åœ¨æˆ¿é—´çš„å…¶ä»–NPCå›å¤
  2. å¦‚æœæœ‹å‹åœˆæ˜¯NPCå‘çš„ â†’ è§¦å‘è¯¥NPCæ‰€åœ¨æˆ¿é—´çš„NPCå›å¤
  3. å¦‚æœæœ‹å‹åœˆæ˜¯ç©å®¶å‘çš„ â†’ è§¦å‘è¯¥ç©å®¶æ‰€æœ‰åŠ å…¥æˆ¿é—´çš„NPCå›å¤

**æµ‹è¯•æ–¹æ³•ï¼š**
```
1. åœ¨æœ‹å‹åœˆæ‰¾åˆ°ä¸€ä¸ªNPCçš„è¯„è®º
2. ç‚¹å‡»å›å¤è¯¥è¯„è®º
3. è¾“å…¥å†…å®¹å‘é€
4. æŸ¥çœ‹ç»ˆç«¯æ—¥å¿—ï¼š
   ğŸ”” è§¦å‘NPCè‡ªåŠ¨å›å¤
   ğŸ  å›å¤çš„æ˜¯NPCè¯„è®ºï¼ŒNPCæ‰€åœ¨æˆ¿é—´ID: XXX
5. ç­‰å¾…15-20ç§’
6. åˆ·æ–°æœ‹å‹åœˆ
7. åº”è¯¥èƒ½çœ‹åˆ°å…¶ä»–NPCçš„å›å¤
```

---

### 2ï¸âƒ£ ç©å®¶æ·»åŠ å¥½å‹åŠŸèƒ½ âœ…

**åŠŸèƒ½è¯´æ˜ï¼š**
- ç©å®¶å¯ä»¥åœ¨æˆ¿é—´å†…æ·»åŠ å…¶ä»–ç©å®¶ä¸ºå¥½å‹
- æ·»åŠ åå¯ä»¥çœ‹åˆ°å¥½å‹çš„æœ‹å‹åœˆ
- å¥½å‹æ˜¾ç¤ºåœ¨"è”ç³»äºº"åˆ—è¡¨ä¸­

**åç«¯APIï¼š**

1. **æ·»åŠ å¥½å‹** - `POST /api/friends/add`
   ```json
   {
     "friend_id": 2
   }
   ```

2. **è·å–å¥½å‹åˆ—è¡¨** - `GET /api/friends/list`
   ```json
   {
     "success": true,
     "friends": [
       {
         "id": 2,
         "username": "user2",
         "nickname": "ç”¨æˆ·2",
         "avatar": "...",
         "created_at": "..."
       }
     ]
   }
   ```

3. **è·å–æˆ¿é—´ç©å®¶** - `GET /api/friends/room-players?roomId=xxx`
   ```json
   {
     "success": true,
     "players": [
       {
         "id": 2,
         "username": "user2",
         "nickname": "ç”¨æˆ·2",
         "avatar": "...",
         "is_friend": 1  // 1è¡¨ç¤ºå·²æ˜¯å¥½å‹ï¼Œ0è¡¨ç¤ºæœªæ·»åŠ 
       }
     ]
   }
   ```

**æ•°æ®åº“è¡¨ï¼š**
- åˆ›å»ºäº† `friendships` è¡¨
- åŒå‘å¥½å‹å…³ç³»ï¼ˆuser_id â†’ friend_idï¼‰

**æœ‹å‹åœˆæ•´åˆï¼š**
- ä¿®æ”¹äº† `server/utils/db-moments.ts` ä¸­çš„ `getFriendsMoments` å‡½æ•°
- ç°åœ¨æŸ¥è¯¢æœ‹å‹åœˆæ—¶ä¼šåŒ…æ‹¬ï¼š
  1. è‡ªå·±å‘çš„æœ‹å‹åœˆ
  2. æˆ¿é—´å†…NPCçš„æœ‹å‹åœˆ
  3. **å¥½å‹ï¼ˆç©å®¶ï¼‰çš„æœ‹å‹åœˆ** â­

**å‰ç«¯å¾…å®ç°ï¼š**
```javascript
// åœ¨æˆ¿é—´é¡µé¢æ·»åŠ "æ·»åŠ å¥½å‹"æŒ‰é’®
// åœ¨è”ç³»äººé¡µé¢æ˜¾ç¤ºå¥½å‹åˆ—è¡¨
// éœ€è¦æ·»åŠ ä»¥ä¸‹åŠŸèƒ½ï¼š

// 1. åœ¨æˆ¿é—´è¯¦æƒ…æˆ–æˆå‘˜åˆ—è¡¨ä¸­æ·»åŠ æŒ‰é’®
const addFriend = async (friendId) => {
  const response = await $fetch('/api/friends/add', {
    method: 'POST',
    body: { friend_id: friendId }
  })
  if (response.success) {
    alert('æ·»åŠ å¥½å‹æˆåŠŸï¼')
    // åˆ·æ–°è”ç³»äººåˆ—è¡¨
  }
}

// 2. åœ¨è”ç³»äººTabæ˜¾ç¤ºå¥½å‹
const fetchFriends = async () => {
  const response = await $fetch('/api/friends/list')
  if (response.success) {
    // æ˜¾ç¤ºå¥½å‹åˆ—è¡¨
  }
}
```

---

### 3ï¸âƒ£ æœ‹å‹åœˆæœªè¯»é€šçŸ¥çº¢ç‚¹ âœ…

**åŠŸèƒ½è¯´æ˜ï¼š**
- æœ‹å‹åœˆTabå³ä¸Šè§’æ˜¾ç¤ºçº¢è‰²æ•°å­—å¾½ç« 
- ç»Ÿè®¡ï¼š
  1. è‡ªå·±æœ‹å‹åœˆçš„æ–°è¯„è®º
  2. è‡ªå·±è¯„è®ºè¢«å›å¤
  3. å‚ä¸è¿‡çš„æœ‹å‹åœˆæœ‰æ–°è¯„è®º
- ç‚¹å‡»æœ‹å‹åœˆTabåè‡ªåŠ¨æ¸…é›¶

**åç«¯APIï¼š**

1. **è·å–æœªè¯»æ•°é‡** - `GET /api/moments/unread-count`
   ```json
   {
     "success": true,
     "count": 5
   }
   ```

2. **æ ‡è®°å·²è¯»** - `POST /api/moments/mark-read`
   ```json
   {
     "success": true
   }
   ```

**å‰ç«¯å®ç°ï¼š**
- å·²ä¿®æ”¹ `pages/index.vue`ï¼š
  ```javascript
  // 1. æ·»åŠ äº†æœªè¯»æ•°é‡çŠ¶æ€
  const momentsUnreadCount = ref(0)
  
  // 2. ä¿®æ”¹äº†tabsé…ç½®
  const tabs = computed(() => [
    { key: 'chats', label: 'èŠå¤©', icon: 'ğŸ’¬', badge: 0 },
    { key: 'contacts', label: 'è”ç³»äºº', icon: 'ğŸ‘¥', badge: 0 },
    { key: 'moments', label: 'æœ‹å‹åœˆ', icon: 'ğŸ­', badge: momentsUnreadCount.value },  // â­
    { key: 'profile', label: 'æˆ‘çš„', icon: 'ğŸ‘¤', badge: 0 }
  ])
  
  // 3. æ·»åŠ äº†è·å–æœªè¯»æ•°é‡å‡½æ•°
  const fetchMomentsUnreadCount = async () => {
    const response = await $fetch('/api/moments/unread-count')
    if (response.success) {
      momentsUnreadCount.value = response.count || 0
    }
  }
  
  // 4. åˆ‡æ¢åˆ°æœ‹å‹åœˆTabæ—¶æ ‡è®°å·²è¯»
  const switchTab = async (tab) => {
    if (tab === 'moments') {
      await markMomentsAsRead()
      momentsUnreadCount.value = 0  // æ¸…é›¶
    }
  }
  ```

**æ•°æ®åº“ï¼š**
- ä½¿ç”¨ç°æœ‰çš„ `moment_notification_status` è¡¨
- è®°å½•æ¯ä¸ªç”¨æˆ·çš„ `last_check_at` æ—¶é—´

---

## éœ€è¦å‰ç«¯å®Œå–„çš„éƒ¨åˆ†

### 1. æ·»åŠ å¥½å‹UIï¼ˆåœ¨æˆ¿é—´é¡µé¢ï¼‰

åœ¨ `pages/room/[id].vue` ä¸­æ·»åŠ ï¼š
```vue
<!-- æˆ¿é—´æˆå‘˜åˆ—è¡¨ä¸­æ·»åŠ "æ·»åŠ å¥½å‹"æŒ‰é’® -->
<div v-for="player in roomPlayers" :key="player.id" class="player-item">
  <span>{{ player.nickname }}</span>
  <button 
    v-if="!player.is_friend" 
    @click="addFriend(player.id)"
    class="btn-add-friend"
  >
    â• æ·»åŠ å¥½å‹
  </button>
  <span v-else class="friend-tag">âœ… å·²æ˜¯å¥½å‹</span>
</div>

<script setup>
// è·å–æˆ¿é—´ç©å®¶
const loadRoomPlayers = async () => {
  const response = await $fetch('/api/friends/room-players', {
    params: { roomId: roomId.value }
  })
  if (response.success) {
    roomPlayers.value = response.players
  }
}

// æ·»åŠ å¥½å‹
const addFriend = async (friendId) => {
  const response = await $fetch('/api/friends/add', {
    method: 'POST',
    body: { friend_id: friendId }
  })
  if (response.success) {
    alert('æ·»åŠ å¥½å‹æˆåŠŸï¼')
    loadRoomPlayers()  // åˆ·æ–°
  } else {
    alert(response.error || 'æ·»åŠ å¤±è´¥')
  }
}
</script>
```

### 2. è”ç³»äººåˆ—è¡¨æ˜¾ç¤ºå¥½å‹

åœ¨ `pages/index.vue` çš„è”ç³»äººTabä¸­æ·»åŠ ï¼š
```vue
<!-- åœ¨ç°æœ‰NPCè”ç³»äººä¸‹æ–¹æ·»åŠ  -->
<div class="section">
  <h3 class="section-title">æˆ‘çš„å¥½å‹ç©å®¶ï¼ˆ{{ playerFriends.length }}ï¼‰</h3>
  <div
    v-for="friend in playerFriends"
    :key="friend.id"
    class="contact-item"
    @click="viewFriendProfile(friend)"
  >
    <div class="contact-avatar">
      <img v-if="friend.avatar" :src="friend.avatar" />
      <span v-else>ğŸ‘¤</span>
    </div>
    <div class="contact-info">
      <div class="contact-name">{{ friend.nickname || friend.username }}</div>
    </div>
  </div>
</div>

<script setup>
// æ·»åŠ çŠ¶æ€
const playerFriends = ref([])

// åŠ è½½å¥½å‹
const fetchFriends = async () => {
  const response = await $fetch('/api/friends/list')
  if (response.success) {
    playerFriends.value = response.friends
  }
}
</script>
```

### 3. åˆå§‹åŒ–æœªè¯»æ•°é‡

åœ¨ `pages/index.vue` çš„åˆå§‹åŒ–ä¸­æ·»åŠ ï¼š
```javascript
// åœ¨ init() æˆ– onMounted() ä¸­
onMounted(async () => {
  await checkAuth()
  fetchMyRooms()
  fetchPresetRooms()
  fetchContacts()
  fetchMomentsUnreadCount()  // â­ æ·»åŠ è¿™ä¸€è¡Œ
  
  // å®šæœŸåˆ·æ–°æœªè¯»æ•°é‡ï¼ˆæ¯30ç§’ï¼‰
  setInterval(() => {
    fetchMomentsUnreadCount()
  }, 30000)
})
```

---

## æµ‹è¯•æ¸…å•

### âœ… NPCå›å¤åŠŸèƒ½
- [ ] å›å¤NPCçš„è¯„è®ºï¼Œç­‰å¾…15ç§’ï¼Œåˆ·æ–°åçœ‹åˆ°å…¶ä»–NPCå›å¤
- [ ] ç»ˆç«¯æ˜¾ç¤ºæ­£ç¡®çš„æ—¥å¿—ï¼ˆæˆ¿é—´IDã€NPCåˆ—è¡¨ç­‰ï¼‰

### âœ… å¥½å‹åŠŸèƒ½
- [ ] åœ¨æˆ¿é—´å†…æ·»åŠ å…¶ä»–ç©å®¶ä¸ºå¥½å‹
- [ ] è”ç³»äººåˆ—è¡¨æ˜¾ç¤ºå¥½å‹
- [ ] æœ‹å‹åœˆèƒ½çœ‹åˆ°å¥½å‹çš„åŠ¨æ€
- [ ] ä¸èƒ½é‡å¤æ·»åŠ å¥½å‹
- [ ] ä¸èƒ½æ·»åŠ è‡ªå·±ä¸ºå¥½å‹

### âœ… æœªè¯»é€šçŸ¥
- [ ] æœ‰æ–°è¯„è®ºæ—¶ï¼Œæœ‹å‹åœˆTabæ˜¾ç¤ºçº¢è‰²æ•°å­—
- [ ] ç‚¹å‡»æœ‹å‹åœˆTabåï¼Œæ•°å­—æ¸…é›¶
- [ ] åˆ·æ–°é¡µé¢åï¼Œæ•°å­—æ­£ç¡®æ˜¾ç¤º

---

## æ–‡ä»¶æ¸…å•

### æ–°å»ºæ–‡ä»¶ï¼š
1. `server/api/friends/add.post.ts` - æ·»åŠ å¥½å‹
2. `server/api/friends/list.get.ts` - è·å–å¥½å‹åˆ—è¡¨
3. `server/api/friends/room-players.get.ts` - è·å–æˆ¿é—´ç©å®¶
4. `server/api/moments/unread-count.get.ts` - è·å–æœªè¯»æ•°é‡
5. `server/api/moments/mark-read.post.ts` - æ ‡è®°å·²è¯»

### ä¿®æ”¹æ–‡ä»¶ï¼š
1. `server/utils/db.ts` - æ·»åŠ  friendships è¡¨
2. `server/api/moments/comment.post.ts` - ä¿®å¤NPCå›å¤é€»è¾‘
3. `server/utils/db-moments.ts` - æœ‹å‹åœˆæŸ¥è¯¢æ”¯æŒå¥½å‹
4. `pages/index.vue` - æœªè¯»é€šçŸ¥UI

---

## ä¸‹ä¸€æ­¥

1. åœ¨å‰ç«¯æ·»åŠ "æ·»åŠ å¥½å‹"æŒ‰é’®ï¼ˆæˆ¿é—´é¡µé¢ï¼‰
2. åœ¨è”ç³»äººTabæ˜¾ç¤ºå¥½å‹åˆ—è¡¨
3. åˆå§‹åŒ–æœªè¯»æ•°é‡çš„è½®è¯¢
4. æµ‹è¯•æ‰€æœ‰åŠŸèƒ½

éœ€è¦æˆ‘ç»§ç»­å®ç°å‰ç«¯UIå—ï¼Ÿ

